---
phase: 04-database-operations
plan: "02"
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified:
  - src/commands/db/schema.ts
  - src/commands/db/query.ts
  - src/cli.ts
autonomous: false
requirements:
  - DB-01
  - DB-02
  - DB-03
  - DB-04
  - DB-05

must_haves:
  truths:
    - "notion db schema <id/url> prints property names, types, and select/status option names"
    - "notion db query <id/url> prints all database entries in a table (TTY) or JSON (piped)"
    - "notion db query --filter 'Status=Done' filters entries to matching rows only"
    - "notion db query --sort 'Name:asc' returns entries sorted by the property"
    - "notion db query --columns 'Title,Status,Date' limits table columns to the specified set"
    - "notion db query --json outputs raw JSON regardless of TTY"
    - "notion db schema and notion db query both accept Notion URLs, not just IDs"
    - "Both commands show a helpful error when page is not found or not shared with integration"
  artifacts:
    - path: "src/commands/db/schema.ts"
      provides: "notion db schema <id> command"
      exports: ["dbSchemaCommand"]
    - path: "src/commands/db/query.ts"
      provides: "notion db query <id> command with --filter, --sort, --columns, --json"
      exports: ["dbQueryCommand"]
    - path: "src/cli.ts"
      provides: "db subcommand group registered with schema + query subcommands"
      contains: "dbSchemaCommand|dbQueryCommand"
  key_links:
    - from: "src/commands/db/schema.ts"
      to: "src/services/database.service.ts"
      via: "import { fetchDatabaseSchema } from '../../services/database.service.js'"
      pattern: "fetchDatabaseSchema"
    - from: "src/commands/db/query.ts"
      to: "src/services/database.service.ts"
      via: "import { queryDatabase, buildFilter, buildSorts, displayPropertyValue } from '../../services/database.service.js'"
      pattern: "queryDatabase|buildFilter|buildSorts"
    - from: "src/cli.ts"
      to: "src/commands/db/schema.ts"
      via: "dbCmd.addCommand(dbSchemaCommand())"
      pattern: "dbSchemaCommand"
---

<objective>
Implement the `notion db schema` and `notion db query` commands and wire them into the CLI as a `db` subcommand group.

Purpose: This is the thin command layer that calls the database service, selects output format, and registers commands. The heavy lifting (API, filter building) is already done in 04-01.
Output: src/commands/db/schema.ts, src/commands/db/query.ts, updated src/cli.ts, human verification.
</objective>

<execution_context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</execution_context>

<context>
@.planning/phases/04-database-operations/04-01-SUMMARY.md
@.planning/phases/01-foundation-auth/01-04-SUMMARY.md
@.planning/phases/02-search-discovery-output/02-04-SUMMARY.md

<interfaces>
<!-- From 04-01 (must exist before this plan runs) -->
From src/services/database.service.ts:
```typescript
export interface DatabaseSchema {
  id: string;
  title: string;
  properties: Record<string, DatabasePropertyConfig>;
}
export interface DatabasePropertyConfig {
  id: string;
  name: string;
  type: string;
  options?: Array<{ name: string; color?: string }>;
}
export interface DatabaseEntry {
  id: string;
  properties: Record<string, string>;
  raw: PageObjectResponse;
}
export interface DatabaseQueryOptions {
  filter?: QueryDatabaseParameters['filter'];
  sorts?: QueryDatabaseParameters['sorts'];
  columns?: string[];
}
export async function fetchDatabaseSchema(client: Client, dbId: string): Promise<DatabaseSchema>
export async function queryDatabase(client: Client, dbId: string, opts?: DatabaseQueryOptions): Promise<DatabaseEntry[]>
export function buildFilter(filterStrings: string[], schema: DatabaseSchema): QueryDatabaseParameters['filter'] | undefined
export function buildSorts(sortStrings: string[]): NonNullable<QueryDatabaseParameters['sorts']>
export function displayPropertyValue(prop: PageObjectResponse['properties'][string]): string
```

<!-- From Phase 2 (output utilities) -->
From src/output/format.ts:
```typescript
export function formatTable(rows: string[][], headers: string[]): string
export function formatJSON(data: unknown): string
export function isHumanMode(): boolean
export function printOutput(data: unknown, tableHeaders?: string[], tableRows?: string[][]): void
```

<!-- From Phase 1 infrastructure -->
From src/notion/url-parser.ts:
```typescript
export function parseNotionId(input: string): string
```
From src/notion/client.ts:
```typescript
export function createNotionClient(token: string): Client
```
From src/errors/error-handler.ts:
```typescript
export function withErrorHandling<T extends unknown[]>(fn: (...args: T) => Promise<void>): (...args: T) => Promise<void>
```
From config (resolveToken — use same import path as src/commands/init.ts):
```typescript
export async function resolveToken(): Promise<TokenResult>
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: notion db schema command</name>
  <files>src/commands/db/schema.ts</files>
  <action>
Create `src/commands/db/schema.ts`. This command fetches and displays a database's property schema.

```typescript
import { Command } from 'commander';
import { withErrorHandling } from '../../errors/error-handler.js';
import { resolveToken } from '../../config/token.js'; // use same path as init.ts uses
import { createNotionClient } from '../../notion/client.js';
import { parseNotionId } from '../../notion/url-parser.js';
import { fetchDatabaseSchema } from '../../services/database.service.js';
import { formatTable, formatJSON, isHumanMode } from '../../output/format.js';

export function dbSchemaCommand(): Command {
  return new Command('schema')
    .description('Show database schema (property names, types, and options)')
    .argument('<id>', 'Notion database ID or URL')
    .option('--json', 'Output raw JSON')
    .action(
      withErrorHandling(async (id: string, options: { json?: boolean }) => {
        const { token } = await resolveToken();
        const client = createNotionClient(token);
        const dbId = parseNotionId(id);
        const schema = await fetchDatabaseSchema(client, dbId);

        if (options.json || !isHumanMode()) {
          process.stdout.write(formatJSON(schema) + '\n');
          return;
        }

        // TTY: render as table — one row per property
        const headers = ['PROPERTY', 'TYPE', 'OPTIONS'];
        const rows = Object.values(schema.properties).map((prop) => [
          prop.name,
          prop.type,
          prop.options ? prop.options.map((o) => o.name).join(', ') : '',
        ]);
        process.stdout.write(formatTable(rows, headers) + '\n');
      }),
    );
}
```
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep "db/schema.ts" || echo "no errors"</verify>
  <done>src/commands/db/schema.ts compiles cleanly and exports dbSchemaCommand</done>
</task>

<task type="auto">
  <name>Task 2: notion db query command + CLI wiring</name>
  <files>src/commands/db/query.ts, src/cli.ts</files>
  <action>
**src/commands/db/query.ts:**

```typescript
import { Command } from 'commander';
import { withErrorHandling } from '../../errors/error-handler.js';
import { resolveToken } from '../../config/token.js';
import { createNotionClient } from '../../notion/client.js';
import { parseNotionId } from '../../notion/url-parser.js';
import {
  fetchDatabaseSchema,
  queryDatabase,
  buildFilter,
  buildSorts,
} from '../../services/database.service.js';
import { formatTable, formatJSON, isHumanMode } from '../../output/format.js';

export function dbQueryCommand(): Command {
  return new Command('query')
    .description('Query database entries with optional filtering and sorting')
    .argument('<id>', 'Notion database ID or URL')
    .option('--filter <filter>', 'Filter entries (repeatable): --filter "Status=Done"', collect, [])
    .option('--sort <sort>', 'Sort entries (repeatable): --sort "Name:asc"', collect, [])
    .option('--columns <columns>', 'Comma-separated list of columns to display: --columns "Title,Status"')
    .option('--json', 'Output raw JSON')
    .action(
      withErrorHandling(
        async (
          id: string,
          options: { filter: string[]; sort: string[]; columns?: string; json?: boolean },
        ) => {
          const { token } = await resolveToken();
          const client = createNotionClient(token);
          const dbId = parseNotionId(id);

          // Always fetch schema first (needed for filter building + column ordering)
          const schema = await fetchDatabaseSchema(client, dbId);

          const columns = options.columns
            ? options.columns.split(',').map((c) => c.trim())
            : undefined;

          const filter = options.filter.length
            ? buildFilter(options.filter, schema)
            : undefined;

          const sorts = options.sort.length ? buildSorts(options.sort) : undefined;

          const entries = await queryDatabase(client, dbId, { filter, sorts, columns });

          if (options.json || !isHumanMode()) {
            process.stdout.write(formatJSON(entries.map((e) => e.raw)) + '\n');
            return;
          }

          if (entries.length === 0) {
            process.stdout.write('No entries found.\n');
            return;
          }

          // TTY: render as table
          // Use requested columns or all columns from first entry
          const displayColumns = columns ?? Object.keys(entries[0].properties);
          const headers = displayColumns.map((c) => c.toUpperCase());
          const rows = entries.map((entry) =>
            displayColumns.map((col) => entry.properties[col] ?? ''),
          );
          process.stdout.write(formatTable(rows, headers) + '\n');
          process.stderr.write(`${entries.length} entries\n`);
        },
      ),
    );
}

// Commander value collector helper for repeatable flags
function collect(value: string, previous: string[]): string[] {
  return previous.concat([value]);
}
```

**src/cli.ts changes — add db subcommand group:**

In the existing `src/cli.ts`, add:
1. Import at top with other command imports:
```typescript
import { dbSchemaCommand } from './commands/db/schema.js';
import { dbQueryCommand } from './commands/db/query.js';
```

2. After the profile commands section, add a new `db` subcommand group:
```typescript
// --- Database ---
const dbCmd = new Command('db').description('Database operations');
dbCmd.addCommand(dbSchemaCommand());
dbCmd.addCommand(dbQueryCommand());
program.addCommand(dbCmd);
```
  </action>
  <verify>npm run build 2>&1 | tail -5 && notion db --help 2>&1</verify>
  <done>npm run build succeeds. `notion db --help` shows "schema" and "query" subcommands. `notion db query --help` shows --filter, --sort, --columns, --json options.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify database commands end-to-end with a real Notion database</name>
  <files>— (human verification only)</files>
  <action>Human verification of the complete notion db pipeline using a real Notion database.</action>
  <verify>User approves after testing all database commands</verify>
  <done>User types "approved" confirming schema and query commands work with a real database</done>
  <what-built>
    Complete database operations pipeline:
    - notion db schema &lt;id/url&gt; — prints property names, types, and select options in a table
    - notion db query &lt;id/url&gt; — lists all entries in table or JSON format
    - notion db query --filter "Status=Done" — filters by property value
    - notion db query --sort "Name:asc" — sorts results
    - notion db query --columns "Title,Status" — limits displayed columns
    - notion db query --json — outputs raw JSON array
  </what-built>
  <how-to-verify>
    1. Run `npm run build` — must succeed
    2. Run `notion db --help` — verify schema and query subcommands appear
    3. Run `notion db schema &lt;your-database-id-or-url&gt;` — verify:
       - Table shows PROPERTY, TYPE, OPTIONS columns
       - Select/status properties show their valid options
    4. Run `notion db query &lt;your-database-id-or-url&gt;` — verify:
       - Table shows database entries with property values
       - Multiple entries displayed
    5. Run `notion db query &lt;id&gt; --filter "Status=Done"` (use a real property/value) — verify filtered results
    6. Run `notion db query &lt;id&gt; --sort "Title:asc"` — verify sorted order
    7. Run `notion db query &lt;id&gt; --columns "Title,Status"` — verify only those columns appear
    8. Run `notion db query &lt;id&gt; --json` — verify JSON array output
    9. Run `notion db query &lt;id&gt; | cat` — verify JSON output when piped
  </how-to-verify>
  <resume-signal>Type "approved" if all commands work. Describe any issues if not.</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `notion db --help` shows schema and query subcommands
- `notion db schema <real-id>` shows property table with types and options
- `notion db query <real-id>` shows entries table
- `notion db query <real-id> --filter "Prop=Val"` returns filtered results
- `notion db query <real-id> --json` returns JSON array
- `notion db query <real-id> | cat` returns JSON (piped mode)
- User approves checkpoint
</verification>

<success_criteria>
- All 5 DB requirements addressed (DB-01 through DB-05)
- schema command: property names, types, and select/status options displayed
- query command: entries displayed with pagination, filter, sort, column selection
- Both commands accept URLs and IDs
- CLI wiring complete — db subcommand registered
- Human checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/04-database-operations/04-02-SUMMARY.md`
</output>
