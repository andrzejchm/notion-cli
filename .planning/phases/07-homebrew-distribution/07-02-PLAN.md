---
phase: 07-homebrew-distribution
plan: 02
type: execute
wave: 2
depends_on:
  - 07-01
files_modified:
  - homebrew-notion-cli/.github/workflows/update-formula.yml
  - README.md
autonomous: false
requirements:
  - ADV-04

must_haves:
  truths:
    - "README.md documents `brew install` as a primary installation method alongside npm"
    - "A GitHub Actions workflow in homebrew-notion-cli auto-updates the formula when a new npm version is published"
    - "The workflow computes the sha256 of the new tarball and commits an updated formula"
  artifacts:
    - path: "homebrew-notion-cli/.github/workflows/update-formula.yml"
      provides: "Auto-update workflow triggered on new npm releases"
      contains: "on: schedule"
    - path: "README.md"
      provides: "Updated install section with brew tap as primary method"
      contains: "brew tap"
  key_links:
    - from: "update-formula.yml"
      to: "registry.npmjs.org API"
      via: "npm info @andrzejchm/notion-cli version"
      pattern: "npm info"
    - from: "update-formula.yml"
      to: "homebrew-notion-cli Formula/notion-cli.rb"
      via: "git commit"
      pattern: "git commit"
---

<objective>
Add an auto-update GitHub Actions workflow to the tap repo that polls npm for new versions
and updates the formula sha256 + version automatically. Also update the main notion-cli
README to document Homebrew as the primary install method.

Purpose: Keep the formula current without manual intervention on every `npm publish`.
Output: Automated formula maintenance + polished README install section.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-homebrew-distribution/07-01-SUMMARY.md

<interfaces>
<!-- Tap repo structure after plan 07-01 -->
homebrew-notion-cli/
  Formula/notion-cli.rb    # contains version, url, sha256
  README.md

<!-- npm API endpoint -->
GET https://registry.npmjs.org/@andrzejchm/notion-cli/latest
Returns JSON with: { version: "0.1.2", dist: { tarball: "...", shasum: "..." } }

<!-- sha256 of tarball -->
curl -sL "{tarball_url}" | shasum -a 256

<!-- Formula fields to update on each release -->
url "https://registry.npmjs.org/@andrzejchm/notion-cli/-/notion-cli-{VERSION}.tgz"
sha256 "{SHA256}"
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-update GitHub Actions workflow to tap repo</name>
  <files>homebrew-notion-cli/.github/workflows/update-formula.yml</files>
  <action>
    In `/Users/andrzejchm/Developer/homebrew-notion-cli`, create `.github/workflows/update-formula.yml`:

    ```yaml
    name: Update Formula

    on:
      schedule:
        # Runs every day at 08:00 UTC
        - cron: "0 8 * * *"
      workflow_dispatch:
        # Allow manual trigger

    jobs:
      update:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout tap
            uses: actions/checkout@v4

          - name: Check for new npm version
            id: npm
            run: |
              LATEST=$(curl -s https://registry.npmjs.org/@andrzejchm/notion-cli/latest | jq -r '.version')
              CURRENT=$(grep 'url "https://registry' Formula/notion-cli.rb | grep -oP '\d+\.\d+\.\d+')
              echo "latest=$LATEST" >> "$GITHUB_OUTPUT"
              echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
              if [ "$LATEST" = "$CURRENT" ]; then
                echo "up_to_date=true" >> "$GITHUB_OUTPUT"
              else
                echo "up_to_date=false" >> "$GITHUB_OUTPUT"
              fi

          - name: Update formula
            if: steps.npm.outputs.up_to_date == 'false'
            env:
              VERSION: ${{ steps.npm.outputs.latest }}
            run: |
              TARBALL_URL="https://registry.npmjs.org/@andrzejchm/notion-cli/-/notion-cli-${VERSION}.tgz"
              SHA256=$(curl -sL "$TARBALL_URL" | shasum -a 256 | awk '{print $1}')
              
              sed -i "s|url \"https://registry.npmjs.org/@andrzejchm/notion-cli/-/notion-cli-.*\.tgz\"|url \"${TARBALL_URL}\"|" Formula/notion-cli.rb
              sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" Formula/notion-cli.rb
              
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add Formula/notion-cli.rb
              git commit -m "notion-cli ${VERSION}"
              git push
    ```

    Then commit and push:
    ```bash
    cd /Users/andrzejchm/Developer/homebrew-notion-cli
    mkdir -p .github/workflows
    # (write the file above)
    git add .github/workflows/update-formula.yml
    git commit -m "chore: add auto-update workflow"
    git push origin main
    ```
  </action>
  <verify>
    ```bash
    # Trigger workflow manually via gh CLI to test it
    gh workflow run update-formula.yml --repo andrzejchm/homebrew-notion-cli
    # Wait a minute, then check
    gh run list --repo andrzejchm/homebrew-notion-cli --limit 3
    ```
    The workflow should complete (or show "up to date" skip â€” both are passing states).
  </verify>
  <done>
    - `.github/workflows/update-formula.yml` exists in the tap repo
    - Workflow triggers on schedule (daily 08:00 UTC) and manual dispatch
    - Workflow correctly computes sha256 from the tarball URL
    - First manual run completes without errors (either updates or confirms up-to-date)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update notion-cli README with Homebrew install section</name>
  <files>README.md</files>
  <action>
    In the main `notion-cli` repo (`/Users/andrzejchm/Developer/notion-cli`), update `README.md`:

    Replace the current install snippet at the top:
    ```bash
    npm install -g @andrzejchm/notion-cli
    notion init   # paste your Notion integration token
    ```

    With an expanded install section showing Homebrew as the preferred option:
    ```bash
    # Homebrew (recommended)
    brew tap andrzejchm/notion-cli
    brew install notion-cli

    # npm (alternative)
    npm install -g @andrzejchm/notion-cli

    notion init   # paste your Notion integration token once
    ```

    Also add a Homebrew badge next to the existing npm badge:
    ```markdown
    [![homebrew tap](https://img.shields.io/badge/homebrew-andrzejchm%2Fnotion--cli-orange?style=flat&logo=homebrew)](https://github.com/andrzejchm/homebrew-notion-cli)
    ```

    Place this badge after the existing npm version badge.

    Commit this change to the main notion-cli repo:
    ```bash
    cd /Users/andrzejchm/Developer/notion-cli
    git add README.md
    git commit -m "docs: add Homebrew install instructions to README"
    git push origin main
    ```
  </action>
  <verify>
    ```bash
    grep -n "brew tap" README.md   # should show the brew install lines
    grep -n "homebrew" README.md   # should show the badge line
    ```
    Both lines should appear in README.md.
  </verify>
  <done>
    - README.md shows Homebrew as the recommended install path
    - Homebrew badge appears next to the npm badge
    - Change committed and pushed to main branch
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 3: Verify auto-update workflow and README update</name>
  <what-built>
    - GitHub Actions workflow that auto-updates the formula on new npm releases
    - Updated README with Homebrew install instructions
  </what-built>
  <how-to-verify>
    1. Visit https://github.com/andrzejchm/homebrew-notion-cli/actions
       - Confirm the "Update Formula" workflow exists
       - Trigger it manually and confirm it runs without errors
    2. Visit https://github.com/andrzejchm/notion-cli#readme
       - Confirm the Homebrew install section is visible near the top
       - Confirm the brew badge appears
    3. Full end-to-end smoke test (if brew install from plan 07-01 was undone):
       ```bash
       brew tap andrzejchm/notion-cli
       brew install notion-cli
       notion --version
       ```
  </how-to-verify>
  <resume-signal>Type "verified" if everything looks good, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `github.com/andrzejchm/homebrew-notion-cli/actions` shows the "Update Formula" workflow
- Workflow runs successfully (confirms up-to-date or updates formula)
- `README.md` in notion-cli repo shows `brew tap andrzejchm/notion-cli && brew install notion-cli`
- `brew install andrzejchm/notion-cli/notion-cli` still works after all changes
</verification>

<success_criteria>
- Formula auto-updates daily from npm without manual intervention
- README presents Homebrew as the primary install path
- Any developer can install notion-cli with only Homebrew (no npm required)
</success_criteria>

<output>
After completion, create `.planning/phases/07-homebrew-distribution/07-02-SUMMARY.md`
</output>
