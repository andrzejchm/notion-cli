---
phase: 08-oauth-login
plan: 02
type: execute
wave: 2
depends_on:
  - "08-01"
files_modified:
  - src/oauth/oauth-flow.ts
  - src/commands/auth/login.ts
  - src/commands/auth/logout.ts
  - src/commands/auth/status.ts
  - src/cli.ts
  - .github/workflows/publish.yml
autonomous: true
requirements:
  - OAUTH-04
  - OAUTH-05
  - OAUTH-06

must_haves:
  truths:
    - "User can run 'notion auth login' and get authenticated via Notion OAuth in their browser"
    - "User can run 'notion auth logout' to remove OAuth tokens from their active profile"
    - "User can run 'notion auth status' to see whether they are authenticated via OAuth or internal token"
    - "Loopback callback server on localhost:54321 catches the OAuth code without any remote server"
    - "Manual flow prints auth URL for headless environments (no browser available)"
  artifacts:
    - path: "src/oauth/oauth-flow.ts"
      provides: "runOAuthFlow() — starts loopback server, opens browser, waits for callback code"
    - path: "src/commands/auth/login.ts"
      provides: "notion auth login command implementation"
    - path: "src/commands/auth/logout.ts"
      provides: "notion auth logout command implementation"
    - path: "src/commands/auth/status.ts"
      provides: "notion auth status command implementation"
    - path: "src/cli.ts"
      provides: "auth subcommand group wired with login/logout/status subcommands"
  key_links:
    - from: "src/commands/auth/login.ts"
      to: "src/oauth/oauth-flow.ts"
      via: "await runOAuthFlow()"
    - from: "src/oauth/oauth-flow.ts"
      to: "src/oauth/oauth-client.ts"
      via: "exchangeCode() after callback received"
    - from: "src/commands/auth/login.ts"
      to: "src/oauth/token-store.ts"
      via: "saveOAuthTokens(profileName, response)"
---

<objective>
Implement the browser-based OAuth login flow, logout, and auth status commands. Wire them as `notion auth login/logout/status` subcommand group.

Purpose: Users run `notion auth login` once and all subsequent write operations (comment, append, create-page) are attributed to their actual Notion user identity.
Output: Three auth subcommands + the OAuth loopback flow module.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-oauth-login/08-01-SUMMARY.md
@src/oauth/oauth-client.ts
@src/oauth/token-store.ts
@src/config/token.ts
@src/config/config.ts
@src/commands/init.ts
@src/cli.ts

<interfaces>
<!-- From Plan 08-01 -->
```typescript
// src/oauth/oauth-client.ts
export const OAUTH_REDIRECT_URI: string;
export function buildAuthUrl(state: string): string;
export async function exchangeCode(code: string): Promise<OAuthTokenResponse>;
export async function refreshAccessToken(refreshToken: string): Promise<OAuthTokenResponse>;

// src/oauth/token-store.ts
export async function saveOAuthTokens(profileName: string, response: OAuthTokenResponse): Promise<void>;
export async function clearOAuthTokens(profileName: string): Promise<void>;

// src/config/token.ts
export async function resolveToken(): Promise<TokenResult>;
// TokenResult.source === 'oauth' when OAuth token is used

// src/config/config.ts
export async function readGlobalConfig(): Promise<GlobalConfig>;
export async function writeGlobalConfig(config: GlobalConfig): Promise<void>;
```

<!-- Node.js stdlib available -->
import { createServer } from 'node:http';
import { randomBytes } from 'node:crypto';
// open browser: use child_process.spawn with platform-aware command
// macOS: 'open', Linux: 'xdg-open', Windows: 'start'
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: OAuth loopback flow module</name>
  <files>src/oauth/oauth-flow.ts</files>
  <action>
Create `src/oauth/oauth-flow.ts` that implements the browser-based OAuth callback flow using a temporary local HTTP server.

```typescript
export interface OAuthFlowResult {
  code: string;
  state: string;
}

/**
 * Runs the full OAuth browser flow:
 * 1. Generates random state (16 hex bytes via crypto.randomBytes)
 * 2. Starts a temporary HTTP server on localhost:54321
 * 3. Opens the Notion auth URL in the user's browser (or prints it for manual flow)
 * 4. Waits for the callback redirect with ?code=&state=
 * 5. Validates state matches, responds with a success/error HTML page
 * 6. Closes the server and returns { code, state }
 *
 * If --manual flag is set or browser open fails, prints the URL and prompts
 * user to paste the full redirect URL back into the terminal.
 *
 * Throws CliError(AUTH_INVALID) if:
 *   - state mismatch (CSRF attempt)
 *   - Notion returns ?error=access_denied
 *   - Timeout after 120 seconds with no callback
 */
export async function runOAuthFlow(options?: { manual?: boolean }): Promise<OAuthFlowResult>;
```

Implementation details:
- Server listens on `http://localhost:54321` (matches OAUTH_REDIRECT_URI)
- Parse the incoming GET request URL for `code`, `state`, `error` query params
- On success: send HTML response: `<html><body><h1>Authenticated! You can close this tab.</h1></body></html>`
- On error (access_denied): send error HTML, resolve with rejection
- Open browser using `child_process.spawn` with no-wait: macOS = `open`, Linux = `xdg-open`, Windows = `cmd /c start` — wrap in try/catch, if spawn throws, fall back to manual flow automatically
- Manual flow: print `Opening browser to:\n  {url}\n\nPaste the full redirect URL here (http://localhost:54321/oauth/callback?code=...):` and read from stdin using readline, then parse URL params from pasted text
- 120-second timeout: `setTimeout(() => { server.close(); reject(CliError(AUTH_TIMEOUT)) }, 120_000)`
- Server must call `server.close()` in all exit paths (success, error, timeout)
  </action>
  <verify>npx tsc --noEmit 2>&1 | head -20</verify>
  <done>TypeScript compiles. oauth-flow.ts exports runOAuthFlow with correct signature. Server opens on 54321, state validation present, timeout present.</done>
</task>

<task type="auto">
  <name>Task 2: auth login/logout/status commands + CLI wiring</name>
  <files>
    src/commands/auth/login.ts
    src/commands/auth/logout.ts
    src/commands/auth/status.ts
    src/cli.ts
  </files>
  <action>
**src/commands/auth/login.ts** — `notion auth login` command:

```
notion auth login [--profile <name>] [--manual]
```

Flow:
1. Get active profile name: use `--profile` flag if provided, else read `active_profile` from global config, else default to `'default'`
2. If no `active_profile` set and no `--profile` flag, offer to create one: if profile doesn't exist yet, that's fine — we'll create it
3. Run `await runOAuthFlow({ manual: opts.manual })`
4. Call `await exchangeCode(result.code)` to get tokens
5. Call `await saveOAuthTokens(profileName, response)` — also sets `workspace_name`, `workspace_id` from response
6. Print success: `✓ Logged in as {user_name} to workspace {workspace_name}` (use stderrWrite + success())
7. Print hint: `Your comments and pages will now be attributed to your Notion account.`

Error handling: wrapped in `withErrorHandling()`.

---

**src/commands/auth/logout.ts** — `notion auth logout [--profile <name>]`:

1. Resolve profile name (same logic as login)
2. Read config, check if profile has OAuth tokens — if not, print "No OAuth session found for profile '{name}'"
3. Call `clearOAuthTokens(profileName)`
4. Print: `✓ Logged out. OAuth tokens removed from profile '{name}'.`
5. Print hint: `Internal integration token (if any) is still active. Run 'notion init' to change it.`

---

**src/commands/auth/status.ts** — `notion auth status [--profile <name>]`:

Reads config and prints current auth state for the profile. Output (stderr):

```
Profile: default
  OAuth: ✓ Logged in as Andrzej Chm (user: abc123)
         Access token expires: 2026-02-27T22:00:00Z
  Internal token: ✓ Configured (secret_...)
  Active method: OAuth (user-attributed)
```

Or if no OAuth:
```
Profile: default
  OAuth: ✗ Not logged in (run 'notion auth login')
  Internal token: ✓ Configured
  Active method: Internal integration token (bot-attributed)
```

---

**src/cli.ts** — Add `auth` subcommand group:

Find where existing commands are registered (likely the main Command setup). Add:

```typescript
import { loginCommand } from './commands/auth/login.js';
import { logoutCommand } from './commands/auth/logout.js';
import { statusCommand } from './commands/auth/status.js';

// auth subcommand group
const authCmd = new Command('auth').description('manage Notion authentication');
authCmd.addCommand(loginCommand());
authCmd.addCommand(logoutCommand());
authCmd.addCommand(statusCommand());
program.addCommand(authCmd);
```

Place the `auth` group near the top (before other commands) for discoverability.

**Note on TTY check for login:** `notion auth login` requires an interactive TTY (can't run in piped mode since it needs to open a browser or print a URL). Add check: if `!process.stdin.isTTY && !opts.manual`, throw `CliError(AUTH_NO_TOKEN, 'Cannot run interactive OAuth login in non-TTY mode.', 'Use --manual flag to get an auth URL you can open in a browser')`.
  </action>
  <verify>npm run build 2>&1 | tail -10 && node dist/cli.js auth --help</verify>
  <done>Build succeeds. `notion auth --help` shows login/logout/status subcommands. `notion auth login --help` shows --profile and --manual flags. `notion auth logout --help` and `notion auth status --help` work.</done>
</task>

</tasks>

<verification>
npm run build && node dist/cli.js auth --help && node dist/cli.js auth login --help
</verification>

<success_criteria>
- Build succeeds with zero TypeScript errors
- `notion auth --help` shows login, logout, status subcommands
- `notion auth login --help` shows --profile and --manual flags
- `notion auth status` runs without crashing (shows current auth state)
- `notion auth logout` removes OAuth tokens from config when present
</success_criteria>

<output>
After completion, create `.planning/phases/08-oauth-login/08-02-SUMMARY.md`
</output>
