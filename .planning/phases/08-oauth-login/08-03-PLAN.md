---
phase: 08-oauth-login
plan: 03
type: execute
wave: 3
depends_on:
  - "08-01"
  - "08-02"
files_modified:
  - docs/agent-skill.md
  - README.md
  - src/commands/init.ts
autonomous: false
requirements:
  - OAUTH-07
  - OAUTH-08

must_haves:
  truths:
    - "notion init help text updated: mentions OAuth login as the preferred auth method for write operations"
    - "README documents OAuth login flow with step-by-step setup"
    - "Agent skill file documents the auth login/logout/status commands"
    - "User can run the full OAuth flow end-to-end (auth login → token stored → notion comment works as user)"
  artifacts:
    - path: "docs/agent-skill.md"
      provides: "Updated with auth login/logout/status commands and OAuth vs internal token explanation"
    - path: "README.md"
      provides: "OAuth setup section explaining when to use auth login vs init"
    - path: "src/commands/init.ts"
      provides: "Updated hint at end of init suggesting 'notion auth login' for user-attributed writes"
  key_links:
    - from: "docs/agent-skill.md"
      to: "src/commands/auth/login.ts"
      via: "documents notion auth login command"
    - from: "README.md"
      to: "docs/agent-skill.md"
      via: "links to agent-skill.md for full command reference"
---

<objective>
Update documentation and the init command hint to surface OAuth login as the preferred method for user-attributed write operations. Verify the full E2E flow works.

Purpose: Users (especially developers) need to understand when to use `notion auth login` vs `notion init`, and AI agents need updated skill docs.
Output: Updated README, agent-skill.md, init hint, and human verification that auth login → comment → attribution works.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-oauth-login/08-01-SUMMARY.md
@.planning/phases/08-oauth-login/08-02-SUMMARY.md
@docs/agent-skill.md
@README.md
@src/commands/init.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update init hint, README, and agent-skill docs</name>
  <files>
    src/commands/init.ts
    docs/agent-skill.md
    README.md
  </files>
  <action>
**src/commands/init.ts** — At the end of the success flow (after the integration access check), add a hint:

```typescript
stderrWrite('');
stderrWrite(dim('To post comments and create pages attributed to your user account:'));
stderrWrite(dim('  notion auth login'));
```

This replaces the current hint about "Write commands require additional capabilities" (keep that hint too, but add the OAuth hint after it).

---

**docs/agent-skill.md** — Add a new section `## Authentication` near the top (after the overview, before command reference). Cover:

1. **Internal integration token (default)** — set up via `notion init`. Comments and pages created via this method are attributed to the integration bot.
2. **OAuth user authentication (recommended for write operations)** — set up via `notion auth login`. Comments and pages are attributed to the actual Notion user.
3. Commands:
   - `notion auth login [--profile <name>] [--manual]` — opens browser OAuth flow; `--manual` for headless
   - `notion auth logout [--profile <name>]` — removes OAuth tokens
   - `notion auth status [--profile <name>]` — shows current auth state

---

**README.md** — Add an `## Authentication` section after the Quick Start section. Cover:

### Internal integration token
Run `notion init`. Suitable for read-only operations and automated agents. Write operations are attributed to the integration bot.

### OAuth user login (recommended for write operations)
Run `notion auth login`. Notion opens in your browser. After approving, your comments and pages will be attributed to your actual Notion account — not the integration.

```bash
notion auth login       # Opens browser, authenticates
notion comment <id> -m "My comment"  # Now attributed to your user
notion auth status      # Check auth state
notion auth logout      # Remove OAuth session
```

Headless / remote servers: `notion auth login --manual` prints the auth URL for you to open in a local browser, then prompts you to paste the redirect URL back.

**Auth priority:** If both `notion init` (integration token) and `notion auth login` (OAuth) are configured, OAuth takes precedence for API calls.
  </action>
  <verify>npm run build 2>&1 | tail -5 && node dist/cli.js --help | grep auth</verify>
  <done>Build succeeds. `notion --help` shows `auth` command. README has Authentication section. agent-skill.md has auth commands documented.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete OAuth login system:
    - notion auth login — opens browser OAuth flow, stores access_token + refresh_token in profile
    - notion auth logout — removes OAuth tokens
    - notion auth status — shows auth state
    - resolveToken() prefers OAuth token (user-attributed) over internal token (bot-attributed)
    - Auto-refresh when access token expires
    - README and agent-skill.md updated
  </what-built>
  <how-to-verify>
    **Pre-requisite:** You need a public Notion integration with OAuth configured. If you haven't set one up yet, you can still verify the structure:

    1. Check commands exist:
       ```
       notion auth --help
       notion auth login --help
       notion auth logout --help
       notion auth status --help
       ```

    2. Check auth status (no OAuth configured yet):
       ```
       notion auth status
       ```
       Should show: "OAuth: ✗ Not logged in"

    3. If you have a public Notion integration configured (NOTION_OAUTH_CLIENT_ID + NOTION_OAUTH_CLIENT_SECRET set or bundled):
       ```
       notion auth login
       ```
       → Browser should open to Notion OAuth page
       → After approving, terminal shows "✓ Logged in as {your name}"
       
       Then test write attribution:
       ```
       notion comment <any-page-id> -m "Test OAuth comment"
       ```
       → Open Notion in browser → comment should be attributed to YOUR user, not the integration bot

    4. Test logout:
       ```
       notion auth logout
       notion auth status
       ```
       Should show OAuth: ✗ Not logged in again.

    5. Read README Authentication section — confirm it explains both flows clearly.
  </how-to-verify>
  <resume-signal>Type "approved" if OAuth flow works end-to-end, or describe what's missing/broken</resume-signal>
</task>

</tasks>

<verification>
npm run build && node dist/cli.js auth --help
</verification>

<success_criteria>
- notion auth login/logout/status are accessible subcommands
- README.md has Authentication section with OAuth setup instructions
- agent-skill.md documents the auth commands
- notion init shows hint about auth login for user-attributed writes
- End-to-end: after auth login, comments appear under user's name in Notion (human verified)
</success_criteria>

<output>
After completion, create `.planning/phases/08-oauth-login/08-03-SUMMARY.md`
</output>
