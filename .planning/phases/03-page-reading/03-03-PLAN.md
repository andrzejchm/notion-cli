---
phase: 03-page-reading
plan: "03"
type: tdd
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/blocks/converters.ts
  - tests/blocks/converters.test.ts
autonomous: true
requirements:
  - PAGE-02

must_haves:
  truths:
    - "Paragraph blocks render as plain text followed by newline"
    - "Heading 1/2/3 blocks render as #/##/### markdown headings"
    - "Bulleted list items render as - text"
    - "Numbered list items render with the caller-provided number (1., 2., 3.)"
    - "To-do items render as - [x] (checked) or - [ ] (unchecked)"
    - "Code blocks render as ```language\\ncode\\n```"
    - "Quote blocks render as > text"
    - "Dividers render as ---"
    - "Callout blocks render as > [emoji/icon] text"
    - "Toggle blocks render as **text** (header bold, children indented below)"
    - "Image blocks render as ![caption](url) with expiry comment for Notion-hosted URLs"
    - "Bookmark blocks render as [url](url)"
    - "child_page blocks render as ### [page title]"
    - "child_database blocks render as ### [database title]"
    - "Unknown/unsupported block types render as <!-- unsupported block: type -->"
  artifacts:
    - path: "src/blocks/converters.ts"
      provides: "Block type registry mapping Notion block types to markdown strings"
      exports: ["blockToMd", "BlockConverterContext"]
    - path: "tests/blocks/converters.test.ts"
      provides: "Test coverage for all 14 P1 block types plus unknown fallback"
      contains: "describe('blockToMd'"
  key_links:
    - from: "src/blocks/converters.ts"
      to: "src/blocks/rich-text.ts"
      via: "import { richTextToMd } from './rich-text.js'"
      pattern: "richTextToMd"
    - from: "src/blocks/render.ts"
      to: "src/blocks/converters.ts"
      via: "import { blockToMd } from './converters.js'"
      pattern: "blockToMd"
---

<objective>
Build the block type converter registry using test-driven development, covering all 14 P1 block types.

Purpose: Block conversion is the highest-complexity component of Phase 3 â€” 14 required block types, each with distinct markdown patterns. TDD ensures each converter is correct before wiring into the render pipeline. The registry pattern (not a giant switch) keeps each converter isolated and testable.
Output: src/blocks/converters.ts with blockToMd() registry and a comprehensive test suite.
</objective>

<execution_context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</execution_context>

<context>
@.planning/phases/03-page-reading/03-01-SUMMARY.md
@.planning/research/PITFALLS.md

<interfaces>
<!-- From Plan 03-01 (must exist before this plan runs) -->
From src/blocks/rich-text.ts:
```typescript
import type { RichTextItemResponse } from '@notionhq/client/build/src/api-endpoints.js';

// Converts an array of rich text items to a markdown string
// Handles bold, italic, code, strikethrough, links, mentions, equations
export function richTextToMd(richText: RichTextItemResponse[]): string
```

<!-- Notion block types needed -->
From @notionhq/client (types):
```typescript
import type { BlockObjectResponse } from '@notionhq/client/build/src/api-endpoints.js';
// BlockObjectResponse is a discriminated union on .type:
// 'paragraph' | 'heading_1' | 'heading_2' | 'heading_3'
// 'bulleted_list_item' | 'numbered_list_item' | 'to_do'
// 'code' | 'quote' | 'divider' | 'callout' | 'toggle'
// 'image' | 'bookmark' | 'child_page' | 'child_database'
// 'table' | 'column_list' | 'synced_block' | 'unsupported' | many more

// Each typed block has its data at block[block.type]:
// block.paragraph.rich_text: RichTextItemResponse[]
// block.heading_1.rich_text: RichTextItemResponse[]
// block.heading_1.is_toggleable: boolean
// block.bulleted_list_item.rich_text: RichTextItemResponse[]
// block.bulleted_list_item.color: string
// block.numbered_list_item.rich_text: RichTextItemResponse[]
// block.to_do.rich_text: RichTextItemResponse[]
// block.to_do.checked: boolean
// block.code.rich_text: RichTextItemResponse[]
// block.code.language: string (e.g. 'javascript', 'python', 'plain text')
// block.code.caption: RichTextItemResponse[]
// block.quote.rich_text: RichTextItemResponse[]
// block.callout.rich_text: RichTextItemResponse[]
// block.callout.icon: { type:'emoji', emoji:string } | { type:'external', external:{url:string} } | null
// block.toggle.rich_text: RichTextItemResponse[]
// block.image: { type:'file', file:{url:string,expiry_time:string} } | { type:'external', external:{url:string} }
// block.image.caption: RichTextItemResponse[]
// block.bookmark.url: string
// block.bookmark.caption: RichTextItemResponse[]
// block.child_page.title: string
// block.child_database.title: string
```
</interfaces>
</context>

<feature>
  <name>Block type converter registry</name>
  <files>src/blocks/converters.ts, tests/blocks/converters.test.ts</files>
  <behavior>
Export a context type and converter function:
```typescript
export interface BlockConverterContext {
  listNumber?: number;    // For numbered_list_item: the 1-based position in the list
  childrenMd?: string;    // Pre-rendered children markdown (render.ts provides this)
}

export function blockToMd(block: BlockObjectResponse, ctx?: BlockConverterContext): string
```

**RED phase â€” write ALL failing tests first. Test each block type with minimal fixture objects:**

```typescript
// helper to build a minimal block fixture
function makeBlock(type: string, typeData: unknown, extra?: unknown): BlockObjectResponse

describe('blockToMd', () => {
  // paragraph
  it('renders paragraph as text + newline', ...)
  // â†’ 'Hello world\n'

  // heading_1 / heading_2 / heading_3
  it('renders heading_1 as # text', ...)   // â†’ '# Title\n'
  it('renders heading_2 as ## text', ...)  // â†’ '## Title\n'
  it('renders heading_3 as ### text', ...) // â†’ '### Title\n'

  // bulleted_list_item (no children)
  it('renders bulleted_list_item as - text', ...) // â†’ '- Item\n'

  // bulleted_list_item (with children indented)
  it('indents children of bulleted_list_item', ...)
  // ctx.childrenMd = '- Child\n' â†’ '- Item\n  - Child\n'

  // numbered_list_item with ctx.listNumber
  it('renders numbered_list_item with provided number', ...)
  // ctx.listNumber = 2 â†’ '2. Item\n'
  // no listNumber â†’ '1. Item\n' (default)

  // to_do unchecked
  it('renders unchecked to_do', ...) // â†’ '- [ ] Task\n'

  // to_do checked
  it('renders checked to_do', ...) // â†’ '- [x] Task\n'

  // code block with language
  it('renders code block with language fence', ...)
  // â†’ '```javascript\nconsole.log("hi");\n```\n'

  // code block with 'plain text' language (use empty fence)
  it('uses empty language for plain text code', ...)
  // â†’ '```\ncontent\n```\n'

  // quote
  it('renders quote as > text', ...) // â†’ '> Hello\n'

  // divider
  it('renders divider as ---', ...) // â†’ '---\n'

  // callout with emoji icon
  it('renders callout with emoji prefix', ...)
  // â†’ '> ðŸ’¡ Note content\n'

  // callout without icon
  it('renders callout without icon', ...)
  // â†’ '> Note content\n'

  // toggle (bold heading, children below)
  it('renders toggle header as bold', ...)
  // no children â†’ '**Toggle title**\n'
  // ctx.childrenMd = 'Child content\n' â†’ '**Toggle title**\nChild content\n'

  // image (external URL)
  it('renders external image as ![caption](url)', ...)
  // â†’ '![](https://example.com/img.png)\n'

  // image with caption
  it('includes caption in image alt text', ...)
  // â†’ '![My image](https://example.com/img.png)\n'

  // image (Notion-hosted, has expiry_time)
  it('adds expiry comment for Notion-hosted images', ...)
  // â†’ '![](https://notion.so/signed/...) <!-- expires: 2026-02-27T00:00:00.000Z -->\n'

  // bookmark
  it('renders bookmark as [url](url)', ...)
  // â†’ '[https://example.com](https://example.com)\n'

  // bookmark with caption
  it('renders bookmark caption as link text', ...)
  // â†’ '[Read more](https://example.com)\n'

  // child_page
  it('renders child_page as ### heading', ...)
  // â†’ '### Child Page\n'

  // child_database
  it('renders child_database as ### heading', ...)
  // â†’ '### My Database\n'

  // unknown type
  it('renders unknown block type as HTML comment placeholder', ...)
  // block.type = 'unsupported' â†’ '<!-- unsupported block: unsupported -->\n'

  // completely novel type
  // block.type = 'some_future_type' â†’ '<!-- unsupported block: some_future_type -->\n'
})
```

**GREEN phase implementation notes:**
- Use a `Record<string, (block, ctx) => string>` registry object
- Each entry is a focused function â€” no shared state, no side effects
- Call `richTextToMd()` from `./rich-text.js` for all `rich_text` arrays
- For `numbered_list_item`: use `ctx?.listNumber ?? 1` as the number
- For children indentation: `childrenMd.split('\n').filter(Boolean).map(l => '  ' + l).join('\n') + '\n'`
- For toggle: render header as `**${richTextToMd(block.toggle.rich_text)}**`, then append childrenMd
- For callout icon: emoji type â†’ prepend emoji, external type â†’ skip (no simple text fallback)
- For image: distinguish `block.image.type === 'file'` vs `'external'`. For `'file'` type, add `<!-- expires: ${block.image.file.expiry_time} -->` comment after the image markdown
- Fallback (end of registry lookup): `return \`<!-- unsupported block: ${block.type} -->\n\``

**REFACTOR phase:** If richTextToMd is called in many places, consider a local alias. No behavior changes.
  </behavior>
  <implementation>
Create `src/blocks/converters.ts` with:
1. Import `BlockObjectResponse` type from SDK
2. Import `richTextToMd` from `./rich-text.js`
3. Export `BlockConverterContext` interface
4. Build `converters` registry object (Record<string, fn>)
5. Export `blockToMd(block, ctx?)` that looks up registry and calls fallback for unknown types
  </implementation>
</feature>

<verification>
- `npx vitest run tests/blocks/converters.test.ts` passes with 0 failures
- `npx tsc --noEmit` passes with no type errors in src/blocks/converters.ts
- Test count: at least 20 test cases covering all 14 P1 block types + unknown fallback
- Notion-hosted image adds expiry comment; external image does not
</verification>

<success_criteria>
- All 14 P1 block types convert to correct markdown (verified by tests)
- Unknown block types produce <!-- unsupported block: type --> without throwing
- Numbered list items use ctx.listNumber (1-based, defaults to 1)
- Children content is indented correctly under bulleted/numbered/toggle parents
- Callout emoji prefix renders (ðŸ’¡ style)
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-page-reading/03-03-SUMMARY.md`
</output>
