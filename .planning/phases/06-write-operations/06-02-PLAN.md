---
phase: 06-write-operations
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - src/commands/comment-add.ts
  - src/commands/append.ts
  - src/services/write.service.ts
  - src/cli.ts
autonomous: true
requirements:
  - WRITE-03
  - ADV-05
must_haves:
  truths:
    - "User can run `notion comment <id> -m \"text\"` and a comment is created on that page"
    - "User can run `notion append <id> -m \"# Heading\\nBody\"` and those blocks appear on the page"
    - "Both commands accept -m/--message as the content flag"
    - "Both commands print a success confirmation to stdout"
    - "Both commands properly handle API errors (not found, unauthorized) via withErrorHandling"
    - "notion --help shows comment and append in the command list"
  artifacts:
    - path: "src/services/write.service.ts"
      provides: "addComment(), appendBlocks() — thin wrappers around Notion SDK write calls"
      exports: ["addComment", "appendBlocks"]
    - path: "src/commands/comment-add.ts"
      provides: "`notion comment <id> -m text` command"
      exports: ["commentAddCommand"]
    - path: "src/commands/append.ts"
      provides: "`notion append <id> -m markdown` command"
      exports: ["appendCommand"]
    - path: "src/cli.ts"
      provides: "comment and append commands wired into CLI"
      contains: "commentAddCommand"
  key_links:
    - from: "src/commands/append.ts"
      to: "src/blocks/md-to-blocks.ts"
      via: "mdToBlocks() import"
      pattern: "mdToBlocks"
    - from: "src/commands/comment-add.ts"
      to: "src/services/write.service.ts"
      via: "addComment() import"
      pattern: "addComment"
    - from: "src/cli.ts"
      to: "src/commands/comment-add.ts"
      via: "commentAddCommand import + program.addCommand()"
      pattern: "commentAddCommand"
---

<objective>
Add `notion comment` and `notion append` commands — the two most-used write operations for AI agents.

Purpose:
- `notion comment <id> -m "text"` → agents can leave comments/notes on pages they process
- `notion append <id> -m "markdown"` → agents can write summaries, notes, or content to existing pages

Output: Two new commands wired into the CLI, backed by a thin write.service.ts.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-write-operations/06-01-SUMMARY.md

<interfaces>
<!-- Key types the executor needs. Extracted from codebase. -->

From src/blocks/md-to-blocks.ts (created in Plan 06-01):
```typescript
export function mdToBlocks(md: string): BlockObjectRequest[]
```

From src/errors/error-handler.ts:
```typescript
export function withErrorHandling<T extends (...args: any[]) => Promise<void>>(fn: T): T
```

From src/config/token.ts:
```typescript
export async function resolveToken(): Promise<{ token: string; source: TokenSource }>
```

From src/notion/client.ts:
```typescript
export function createNotionClient(token: string): Client
```

From src/notion/url-parser.ts:
```typescript
export function parseNotionId(idOrUrl: string): string   // returns 32-hex ID
export function toUuid(id: string): string               // converts to UUID format
```

From src/output/stderr.ts:
```typescript
export function reportTokenSource(source: TokenSource): void
```

Notion SDK v5 write methods:
```typescript
// Create a comment on a page (block_id must be UUID format)
client.comments.create({ parent: { page_id: uuid }, rich_text: [{ type: 'text', text: { content: 'text' } }] })

// Append blocks to a page/block
client.blocks.children.append({ block_id: uuid, children: BlockObjectRequest[] })
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create write.service.ts + comment-add command</name>
  <files>src/services/write.service.ts, src/commands/comment-add.ts</files>
  <action>
    **Create `src/services/write.service.ts`:**
    - Import `Client` from `@notionhq/client`
    - Import `BlockObjectRequest` from `@notionhq/client/build/src/api-endpoints.js`
    - Export `addComment(client: Client, pageId: string, text: string): Promise<void>`
      - Calls `client.comments.create({ parent: { page_id: pageId }, rich_text: [{ type: 'text', text: { content: text, link: null }, annotations: { bold:false, italic:false, strikethrough:false, underline:false, code:false, color:'default' } }] })`
      - Note: pageId must be UUID format — caller is responsible for toUuid() conversion
    - Export `appendBlocks(client: Client, blockId: string, blocks: BlockObjectRequest[]): Promise<void>`
      - Calls `client.blocks.children.append({ block_id: blockId, children: blocks })`

    **Create `src/commands/comment-add.ts`:**
    - Command: `notion comment <id> -m <text>`
    - Short: `-m`, long: `--message`, required option (string), description: "comment text to post"
    - Use `withErrorHandling`, `resolveToken`, `createNotionClient`, `parseNotionId`, `toUuid`
    - Call `addComment(client, toUuid(parseNotionId(id)), text)`
    - On success: `process.stdout.write('Comment added.\n')`
    - Argument name: `<id/url>` (Notion page ID or URL)
    - Export: `commentAddCommand(): Command`

    Note: The existing `commentsCommand` in `src/commands/comments.ts` is the read command (list comments). This new `commentAddCommand` is separate — it creates comments. Keep the names distinct.
  </action>
  <verify>
    <automated>cd /Users/andrzejchm/Developer/notion-cli && npm run build 2>&1 | tail -15</automated>
  </verify>
  <done>Build succeeds with no TypeScript errors. Files exist with correct exports.</done>
</task>

<task type="auto">
  <name>Task 2: Create append command + wire both into CLI</name>
  <files>src/commands/append.ts, src/cli.ts</files>
  <action>
    **Create `src/commands/append.ts`:**
    - Command: `notion append <id> -m <markdown>`
    - Short: `-m`, long: `--message`, required option (string), description: "markdown content to append"
    - Use `withErrorHandling`, `resolveToken`, `createNotionClient`, `parseNotionId`, `toUuid`, `mdToBlocks`, `appendBlocks`
    - Steps:
      1. `const pageId = parseNotionId(id)` then `const uuid = toUuid(pageId)`
      2. `const blocks = mdToBlocks(markdown)` — if blocks.length === 0, write "Nothing to append.\n" and return
      3. `await appendBlocks(client, uuid, blocks)`
      4. `process.stdout.write(\`Appended \${blocks.length} block(s).\n\`)`
    - Export: `appendCommand(): Command`

    **Update `src/cli.ts`:**
    - Add imports: `import { commentAddCommand } from './commands/comment-add.js'` and `import { appendCommand } from './commands/append.js'`
    - In the Discovery section (after `commentsCommand`), add:
      ```
      program.addCommand(commentAddCommand());
      program.addCommand(appendCommand());
      ```
    - Keep existing commands unchanged

    Run build to verify no TypeScript errors.
  </action>
  <verify>
    <automated>cd /Users/andrzejchm/Developer/notion-cli && npm run build 2>&1 | tail -10 && node dist/cli.js --help 2>&1 | grep -E "comment|append"</automated>
  </verify>
  <done>
    - `npm run build` exits 0
    - `notion --help` shows both `comment` and `append` in command list
    - `notion comment --help` shows `-m, --message` option
    - `notion append --help` shows `-m, --message` option
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/andrzejchm/Developer/notion-cli
npm run build                          # exits 0, no TS errors
node dist/cli.js --help                # shows comment and append
node dist/cli.js comment --help        # shows -m/--message option
node dist/cli.js append --help         # shows -m/--message option
npm test                               # full suite still passes
```
</verification>

<success_criteria>
- `notion comment --help` prints usage with `-m, --message <text>` required option
- `notion append --help` prints usage with `-m, --message <markdown>` required option
- `npm run build` succeeds with TypeScript strict mode
- `npm test` passes (no regressions from new files)
- Both commands appear in `notion --help` command list
</success_criteria>

<output>
After completion, create `.planning/phases/06-write-operations/06-02-SUMMARY.md`
</output>
