---
phase: 06-write-operations
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - src/commands/create-page.ts
  - src/services/write.service.ts
  - src/cli.ts
autonomous: false
requirements:
  - WRITE-01
must_haves:
  truths:
    - "User can run `notion create-page --parent <id> --title \"Title\"` and a new page is created in Notion"
    - "User can pipe markdown to stdin: `echo '# Hello' | notion create-page --parent <id> --title 'Title'`"
    - "User can pass inline markdown: `notion create-page --parent <id> --title 'Title' -m '# Hello'`"
    - "On success, the command prints the new page URL to stdout (pipeable)"
    - "notion --help shows create-page in the command list"
    - "Human verify: a real page is created in Notion with the correct title and content"
  artifacts:
    - path: "src/commands/create-page.ts"
      provides: "`notion create-page` command accepting --parent, --title, -m/--message, and stdin"
      exports: ["createPageCommand"]
    - path: "src/services/write.service.ts"
      provides: "createPage() — wraps pages.create() SDK call"
      exports: ["addComment", "appendBlocks", "createPage"]
  key_links:
    - from: "src/commands/create-page.ts"
      to: "src/services/write.service.ts"
      via: "createPage() import"
      pattern: "createPage"
    - from: "src/commands/create-page.ts"
      to: "src/blocks/md-to-blocks.ts"
      via: "mdToBlocks() import"
      pattern: "mdToBlocks"
    - from: "src/cli.ts"
      to: "src/commands/create-page.ts"
      via: "createPageCommand import + program.addCommand()"
      pattern: "createPageCommand"
---

<objective>
Add `notion create-page` command — creates a new Notion page under a parent page or database, with optional markdown body content from `-m` flag or stdin.

Purpose: Enables AI agents to create new pages (meeting notes, summaries, task entries) directly from the terminal. Printing the new page URL to stdout makes it pipeable to other commands.

Output: `notion create-page --parent <id> --title "Title" -m "markdown"` creates a page and prints its URL.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-write-operations/06-01-SUMMARY.md
@.planning/phases/06-write-operations/06-02-SUMMARY.md

<interfaces>
<!-- Key types and patterns for this plan. -->

From src/services/write.service.ts (06-02):
```typescript
export async function addComment(client: Client, pageId: string, text: string): Promise<void>
export async function appendBlocks(client: Client, blockId: string, blocks: BlockObjectRequest[]): Promise<void>
// Will add createPage() to this file in this plan
```

From src/blocks/md-to-blocks.ts (06-01):
```typescript
export function mdToBlocks(md: string): BlockObjectRequest[]
```

Notion SDK v5 pages.create() — creates a new page:
```typescript
// Parent can be a page_id (creates subpage) or database_id (creates DB entry)
await client.pages.create({
  parent: { type: "page_id", page_id: uuid },  // or { type: "database_id", database_id: uuid }
  properties: {
    title: {
      title: [{ type: "text", text: { content: "Page Title", link: null } }]
    }
  },
  children: BlockObjectRequest[]  // optional body blocks
})
// Returns PageObjectResponse — has .url property for the new page
```

Note: For database parents, the property key for title varies (not always "title").
Keep it simple — always use page_id parent, always set title property as shown above.
If user passes a database ID as parent, it will still work because Notion treats the root page as parent.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add createPage() to write.service.ts + create create-page command</name>
  <files>src/services/write.service.ts, src/commands/create-page.ts</files>
  <action>
    **Update `src/services/write.service.ts`** — add `createPage()`:
    ```typescript
    export async function createPage(
      client: Client,
      parentId: string,   // UUID format
      title: string,
      blocks: BlockObjectRequest[]
    ): Promise<string> {
      // Returns the URL of the created page
      const response = await client.pages.create({
        parent: { type: 'page_id', page_id: parentId },
        properties: {
          title: {
            title: [{ type: 'text', text: { content: title, link: null } }]
          }
        },
        children: blocks,
      });
      // PageObjectResponse has a url property
      return (response as { url: string }).url;
    }
    ```

    **Create `src/commands/create-page.ts`:**
    - Command: `notion create-page`
    - Required options:
      - `--parent <id/url>` — parent page ID or URL
      - `--title <title>` — page title (string)
    - Optional content input (one of):
      - `-m, --message <markdown>` — inline markdown content
      - stdin (when no -m provided AND stdin is not a TTY, read from process.stdin)
    - Steps in action handler:
      1. Resolve markdown content: if `-m` provided, use it; else if stdin is not TTY (`!process.stdin.isTTY`), read all of stdin as string; else use empty string
      2. `const blocks = mdToBlocks(markdown)` — may be empty (title-only page is fine)
      3. `const parentUuid = toUuid(parseNotionId(parentId))`
      4. `const url = await createPage(client, parentUuid, title, blocks)`
      5. `process.stdout.write(url + '\n')` — print URL (pipeable)
    - Export: `createPageCommand(): Command`

    Reading stdin pattern (for reference):
    ```typescript
    async function readStdin(): Promise<string> {
      const chunks: Buffer[] = [];
      for await (const chunk of process.stdin) {
        chunks.push(Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk));
      }
      return Buffer.concat(chunks).toString('utf-8');
    }
    ```
  </action>
  <verify>
    <automated>cd /Users/andrzejchm/Developer/notion-cli && npm run build 2>&1 | tail -10</automated>
  </verify>
  <done>Build succeeds with no TypeScript errors. Files exist with correct exports.</done>
</task>

<task type="auto">
  <name>Task 2: Wire create-page into CLI + build</name>
  <files>src/cli.ts</files>
  <action>
    **Update `src/cli.ts`:**
    - Add import: `import { createPageCommand } from './commands/create-page.js'`
    - Add after `appendCommand()` line:
      ```
      program.addCommand(createPageCommand());
      ```

    Run final build and verify CLI help:
    ```bash
    npm run build
    node dist/cli.js --help
    node dist/cli.js create-page --help
    npm test
    ```
  </action>
  <verify>
    <automated>cd /Users/andrzejchm/Developer/notion-cli && npm run build 2>&1 | tail -5 && node dist/cli.js --help 2>&1 | grep create-page && node dist/cli.js create-page --help 2>&1</automated>
  </verify>
  <done>
    - `npm run build` exits 0
    - `notion --help` shows `create-page` in command list
    - `notion create-page --help` shows `--parent`, `--title`, `-m/--message` options
    - `npm test` passes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Three write commands now in the CLI:
    1. `notion comment <id> -m "text"` — add comment to a page
    2. `notion append <id> -m "markdown"` — append blocks to a page
    3. `notion create-page --parent <id> --title "Title" -m "markdown"` — create new page

    All require valid Notion token from `notion init`.
  </what-built>
  <how-to-verify>
    Pick any accessible Notion page in your workspace and test:

    **1. Comment:**
    ```bash
    notion comment <your-page-id-or-url> -m "Test comment from notion CLI"
    ```
    Expected: prints "Comment added." → verify comment appears in Notion

    **2. Append:**
    ```bash
    notion append <your-page-id-or-url> -m "## Test Append
    This was appended by the CLI."
    ```
    Expected: prints "Appended 2 block(s)." → verify heading + paragraph appear at bottom of page

    **3. Create page:**
    ```bash
    notion create-page --parent <your-page-id-or-url> --title "CLI Test Page" -m "# Hello
    Created by notion CLI."
    ```
    Expected: prints a notion.so URL → verify new page exists under the parent with correct title and content

    **4. Piped content:**
    ```bash
    echo "# Piped Content\nFrom stdin" | notion create-page --parent <your-page-id-or-url> --title "Piped Test"
    ```
    Expected: prints URL → new page exists with piped markdown as content
  </how-to-verify>
  <resume-signal>Type "approved" when all 3 commands work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
```bash
cd /Users/andrzejchm/Developer/notion-cli
npm run build          # exits 0
npm test               # all tests pass
node dist/cli.js --help | grep -E "comment|append|create-page"   # shows all 3
node dist/cli.js comment --help     # shows --message option
node dist/cli.js append --help      # shows --message option
node dist/cli.js create-page --help # shows --parent, --title, --message options
```
</verification>

<success_criteria>
- All 3 write commands present in `notion --help`
- `notion create-page --parent <id> --title "Test"` creates a real page and returns its URL
- `notion comment <id> -m "text"` posts a real comment
- `notion append <id> -m "# Heading\nBody"` appends real blocks
- `npm test` passes with no regressions
- Human verification: all 3 commands work against a real Notion workspace
</success_criteria>

<output>
After completion, create `.planning/phases/06-write-operations/06-03-SUMMARY.md`
</output>
