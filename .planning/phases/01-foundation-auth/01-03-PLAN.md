---
phase: 01-foundation-auth
plan: 03
type: tdd
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/notion/url-parser.ts
  - tests/notion/url-parser.test.ts
autonomous: true
requirements:
  - AUTH-05

must_haves:
  truths:
    - "Notion page URL (notion.so) is parsed to 32-char hex ID"
    - "Notion page URL (notion.site) is parsed to 32-char hex ID"
    - "Raw UUID with dashes is parsed to 32-char hex ID"
    - "Raw 32-char hex ID passes through unchanged"
    - "Invalid input throws INVALID_ID error with actionable suggestion"
    - "URLs with query parameters and fragments still parse correctly"
  artifacts:
    - path: "src/notion/url-parser.ts"
      provides: "URL/ID parsing for all Notion URL formats"
      exports: ["parseNotionId", "toUuid"]
    - path: "tests/notion/url-parser.test.ts"
      provides: "Comprehensive test coverage for URL parsing"
      min_lines: 60
  key_links:
    - from: "src/notion/url-parser.ts"
      to: "src/errors/cli-error.ts"
      via: "throws CliError on invalid input"
      pattern: "CliError.*INVALID_ID"
---

<objective>
Implement the Notion URL parser using TDD — parse Notion URLs, raw UUIDs, and 32-char hex IDs into the normalized 32-char hex format the Notion API expects.

Purpose: Every command that accepts a page or database ID needs this parser. It's a pure function with well-defined inputs and outputs — perfect for TDD.
Output: Fully tested `parseNotionId()` and `toUuid()` functions.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md

<interfaces>
<!-- Types from Plan 01 that this plan depends on -->

From src/errors/cli-error.ts:
```typescript
export class CliError extends Error {
  constructor(code: ErrorCode, message: string, suggestion?: string);
}
```

From src/errors/codes.ts:
```typescript
export const ErrorCodes: {
  INVALID_ID: 'INVALID_ID';
  INVALID_URL: 'INVALID_URL';
};
```
</interfaces>
</context>

<feature>
  <name>Notion URL/ID Parser</name>
  <files>src/notion/url-parser.ts, tests/notion/url-parser.test.ts</files>
  <behavior>
  parseNotionId(input: string) → string (32-char hex)

  Input → Expected Output:
  - "b55c9c91384d452b81dbd1ef79372b75" → "b55c9c91384d452b81dbd1ef79372b75" (pass-through)
  - "b55c9c91-384d-452b-81db-d1ef79372b75" → "b55c9c91384d452b81dbd1ef79372b75" (strip dashes)
  - "https://www.notion.so/workspace/Page-Title-b55c9c91384d452b81dbd1ef79372b75" → "b55c9c91384d452b81dbd1ef79372b75"
  - "https://www.notion.so/b55c9c91384d452b81dbd1ef79372b75" → "b55c9c91384d452b81dbd1ef79372b75"
  - "https://www.notion.so/workspace/b55c9c91384d452b81dbd1ef79372b75?v=abc123" → "b55c9c91384d452b81dbd1ef79372b75"
  - "https://notion.so/Page-Title-b55c9c91384d452b81dbd1ef79372b75" → "b55c9c91384d452b81dbd1ef79372b75"
  - "https://myworkspace.notion.site/Page-b55c9c91384d452b81dbd1ef79372b75" → "b55c9c91384d452b81dbd1ef79372b75"
  - "https://www.notion.so/workspace/123abc-b55c9c91384d452b81dbd1ef79372b75?v=def#section" → "b55c9c91384d452b81dbd1ef79372b75"
  - "not-a-valid-id" → throws CliError(INVALID_ID)
  - "" → throws CliError(INVALID_ID)
  - "https://google.com/something" → throws CliError(INVALID_ID)

  toUuid(id: string) → string (UUID with dashes)
  - "b55c9c91384d452b81dbd1ef79372b75" → "b55c9c91-384d-452b-81db-d1ef79372b75"
  </behavior>
  <implementation>
  Follow research Pattern 4 (Notion URL Parsing):
  - Three regex patterns: NOTION_ID_REGEX (32-char hex), UUID_REGEX (UUID with dashes), NOTION_URL_REGEX (URL with embedded ID)
  - Support both `notion.so` and `notion.site` domains
  - Extract 32-char hex ID from end of URL path segment
  - `toUuid()` inserts dashes at standard UUID positions (8-4-4-4-12)
  - Throw `CliError(INVALID_ID, 'Cannot parse Notion ID from: ${input}', 'Provide a valid Notion URL or page/database ID')` on failure
  </implementation>
</feature>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-03-SUMMARY.md`
</output>
