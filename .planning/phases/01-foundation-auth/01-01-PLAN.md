---
phase: 01-foundation-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - tsup.config.ts
  - vitest.config.ts
  - src/cli.ts
  - src/types/config.ts
  - src/errors/codes.ts
  - src/errors/cli-error.ts
  - src/errors/error-handler.ts
  - src/output/stderr.ts
  - src/output/color.ts
autonomous: true
requirements:
  - OUT-05
  - DIST-02
  - DIST-04

must_haves:
  truths:
    - "Project builds with tsup and produces dist/cli.js"
    - "Running dist/cli.js --version prints the version from package.json"
    - "CliError.format() produces structured output with code and suggestion"
    - "Errors written to stderr, never stdout"
    - "Color is suppressed when not a TTY"
  artifacts:
    - path: "package.json"
      provides: "Project metadata, dependencies, bin field, type: module"
      contains: '"notion": "./dist/cli.js"'
    - path: "tsconfig.json"
      provides: "TypeScript configuration"
    - path: "tsup.config.ts"
      provides: "CLI bundler config with shebang banner"
    - path: "src/cli.ts"
      provides: "Entry point stub with Commander program, --version, --verbose, --color"
    - path: "src/types/config.ts"
      provides: "TypeScript types for global config and local config"
      exports: ["GlobalConfig", "ProfileConfig", "LocalConfig"]
    - path: "src/errors/codes.ts"
      provides: "Error code constants"
    - path: "src/errors/cli-error.ts"
      provides: "CliError class with code, message, suggestion"
      exports: ["CliError"]
    - path: "src/errors/error-handler.ts"
      provides: "Top-level error handler wrapping command actions"
      exports: ["withErrorHandling"]
    - path: "src/output/stderr.ts"
      provides: "Stderr utilities for error and info output"
    - path: "src/output/color.ts"
      provides: "TTY-aware color wrapper using chalk"
  key_links:
    - from: "src/cli.ts"
      to: "src/errors/error-handler.ts"
      via: "withErrorHandling wraps command actions"
      pattern: "withErrorHandling"
    - from: "src/output/color.ts"
      to: "chalk"
      via: "TTY detection guards color output"
      pattern: "chalk"
---

<objective>
Scaffold the notion-cli project from scratch and establish the error handling + output infrastructure that all commands depend on.

Purpose: Create the buildable project skeleton with types, error system, and output utilities so subsequent plans can implement features against concrete contracts.
Output: Buildable TypeScript CLI project with `notion --version` working, CliError class, stderr utilities, and color support.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffold — package.json, TypeScript, tsup, vitest</name>
  <files>
    package.json
    tsconfig.json
    tsup.config.ts
    vitest.config.ts
    src/types/config.ts
  </files>
  <action>
Initialize the project from scratch:

1. Create `package.json` with:
   - `"name": "@andrzejchm/notion-cli"`
   - `"version": "0.1.0"`
   - `"type": "module"` (CRITICAL — chalk v5, @notionhq/client v5, @inquirer/prompts are ESM-only)
   - `"bin": { "notion": "./dist/cli.js" }`
   - `"scripts": { "build": "tsup", "dev": "tsup --watch", "test": "vitest run", "test:watch": "vitest" }`
   - Dependencies: `commander@^14.0.0`, `@notionhq/client@^5.10.0`, `yaml@^2.8.0`, `@inquirer/prompts@^8.3.0`, `chalk@^5.6.0`
   - DevDependencies: `typescript@~5.9.0`, `tsup@^8.5.0`, `vitest@^4.0.0`, `@commander-js/extra-typings@^14.0.0`, `@types/node@^22`

2. Run `npm install` to install dependencies.

3. Create `tsconfig.json`:
   - `"target": "ES2022"`, `"module": "Node16"`, `"moduleResolution": "Node16"`
   - `"strict": true`, `"esModuleInterop": true`, `"skipLibCheck": true`
   - `"outDir": "dist"`, `"rootDir": "src"`
   - `"include": ["src"]`

4. Create `tsup.config.ts` per research pattern:
   - Entry: `src/cli.ts`, format: `esm`, target: `node22`, clean: true
   - Banner with `#!/usr/bin/env node` shebang
   - sourcemap: true, splitting: false, dts: false

5. Create `vitest.config.ts`:
   - Simple config with `test: { globals: true }`

6. Create `src/types/config.ts` with TypeScript interfaces:
   ```typescript
   export interface ProfileConfig {
     token: string;
     workspace_name?: string;
     workspace_id?: string;
   }

   export interface GlobalConfig {
     active_profile?: string;
     profiles?: Record<string, ProfileConfig>;
   }

   export interface LocalConfig {
     profile?: string;
     token?: string;
   }

   export interface TokenResult {
     token: string;
     source: 'NOTION_API_TOKEN' | '.notion.yaml' | `profile: ${string}`;
   }
   ```
  </action>
  <verify>
    <automated>npm run build && node dist/cli.js --version</automated>
  </verify>
  <done>Project builds successfully with tsup. `node dist/cli.js --version` prints "0.1.0". All dependencies installed. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Error handling system and output utilities</name>
  <files>
    src/errors/codes.ts
    src/errors/cli-error.ts
    src/errors/error-handler.ts
    src/output/stderr.ts
    src/output/color.ts
    src/cli.ts
  </files>
  <action>
Create the error handling and output infrastructure:

1. Create `src/errors/codes.ts` — error code constants:
   ```typescript
   export const ErrorCodes = {
     // Auth errors
     AUTH_NO_TOKEN: 'AUTH_NO_TOKEN',
     AUTH_INVALID: 'AUTH_INVALID',
     AUTH_EXPIRED: 'AUTH_EXPIRED',
     AUTH_PROFILE_NOT_FOUND: 'AUTH_PROFILE_NOT_FOUND',
     // Config errors
     CONFIG_READ_ERROR: 'CONFIG_READ_ERROR',
     CONFIG_WRITE_ERROR: 'CONFIG_WRITE_ERROR',
     CONFIG_INVALID: 'CONFIG_INVALID',
     // Input errors
     INVALID_ID: 'INVALID_ID',
     INVALID_URL: 'INVALID_URL',
     // API errors
     API_ERROR: 'API_ERROR',
     API_RATE_LIMITED: 'API_RATE_LIMITED',
     API_NOT_FOUND: 'API_NOT_FOUND',
     // General
     UNKNOWN: 'UNKNOWN',
   } as const;
   export type ErrorCode = typeof ErrorCodes[keyof typeof ErrorCodes];
   ```

2. Create `src/errors/cli-error.ts` — structured error class per research Pattern 3:
   - `CliError` extends `Error` with `code: ErrorCode`, `suggestion?: string`
   - `format()` method: `[CODE] message\n  → suggestion`
   - Export the class

3. Create `src/errors/error-handler.ts`:
   - `withErrorHandling(fn: () => Promise<void>): () => Promise<void>` wrapper
   - Catches `CliError` → formats and writes to stderr, exits 1
   - Catches Notion SDK errors (lazy import `isNotionClientError` from `@notionhq/client`) → maps to CliError codes
   - Catches unknown errors → wraps with `[UNKNOWN]` code, writes to stderr, exits 1
   - Notion error mapping: `unauthorized` → AUTH_INVALID, `rate_limited` → API_RATE_LIMITED, `object_not_found` → API_NOT_FOUND, others → API_ERROR

4. Create `src/output/color.ts`:
   - Import chalk (ESM: `import chalk from 'chalk'`)
   - Export a `createChalk()` function that respects: TTY detection (`process.stderr.isTTY`), `--color` flag override, `NO_COLOR` env var
   - For non-TTY: return an identity function (no colors)
   - Export color helpers: `error(msg)`, `success(msg)`, `dim(msg)`, `bold(msg)`

5. Create `src/output/stderr.ts`:
   - `stderrWrite(msg: string)`: writes to stderr with newline
   - `reportTokenSource(source: TokenResult['source'])`: prints "Using token from {source}" to stderr (dimmed)
   - `reportError(error: CliError)`: formats and writes error to stderr with color

6. Update `src/cli.ts`:
   - Import and configure Commander with `configureOutput` routing to stderr per research pattern
   - Add global options: `--verbose` (show API requests), `--color` (force color)
   - Wire `withErrorHandling` as the error handler
   - Keep `--version` working
   - Add placeholder `.description('Notion CLI — read Notion pages and databases from the terminal')`
   - Use `await program.parseAsync()` (CRITICAL — not `.parse()` — async actions need this)
  </action>
  <verify>
    <automated>npm run build && node dist/cli.js --version && node dist/cli.js --help 2>&1 | head -5</automated>
  </verify>
  <done>
- `CliError` format produces `[AUTH_INVALID] Invalid token.\n  → Run "notion init" to reconfigure` style output
- `withErrorHandling` catches errors and writes to stderr with exit code 1
- Color is disabled when piped (not TTY)
- `--verbose` and `--color` flags registered as global options
- `--version` still works, `--help` shows description
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `node dist/cli.js --version` prints `0.1.0`
- `node dist/cli.js --help` shows "Notion CLI" description with `--verbose` and `--color` options
- `npm test` runs (even if no tests yet)
- TypeScript compiles with strict mode, no errors
</verification>

<success_criteria>
1. Project builds and produces a working CLI binary at dist/cli.js
2. CliError class formats structured errors with codes and suggestions
3. Error handler catches errors and routes to stderr with exit code 1
4. Color output respects TTY detection
5. Global --verbose and --color flags are registered
6. TypeScript types defined for config structures
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-01-SUMMARY.md`
</output>
