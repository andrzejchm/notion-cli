---
phase: 01-foundation-auth
plan: 04
type: execute
wave: 3
depends_on:
  - "01-02"
  - "01-03"
files_modified:
  - src/cli.ts
  - src/commands/init.ts
  - src/commands/profile/list.ts
  - src/commands/profile/use.ts
  - src/commands/profile/remove.ts
  - src/commands/completion.ts
  - src/notion/client.ts
autonomous: false
requirements:
  - AUTH-01
  - AUTH-02
  - DIST-03

must_haves:
  truths:
    - "User can run notion init, enter a profile name and token, and have it validated and saved"
    - "notion init shows workspace name on successful validation"
    - "notion init offers to replace if profile already exists"
    - "notion init in non-TTY mode errors with guidance to use flags or env vars"
    - "notion profile list shows all profiles with active marker"
    - "notion profile use <name> switches the active profile"
    - "notion profile remove <name> deletes a profile"
    - "notion --help shows commands grouped by category"
    - "notion completion <shell> outputs a shell completion script"
  artifacts:
    - path: "src/commands/init.ts"
      provides: "notion init command with interactive prompts and token validation"
      exports: ["initCommand"]
    - path: "src/commands/profile/list.ts"
      provides: "notion profile list command"
      exports: ["profileListCommand"]
    - path: "src/commands/profile/use.ts"
      provides: "notion profile use command"
      exports: ["profileUseCommand"]
    - path: "src/commands/profile/remove.ts"
      provides: "notion profile remove command"
      exports: ["profileRemoveCommand"]
    - path: "src/commands/completion.ts"
      provides: "notion completion command for bash/zsh/fish"
      exports: ["completionCommand"]
    - path: "src/notion/client.ts"
      provides: "Authenticated Notion client factory"
      exports: ["createNotionClient", "validateToken"]
    - path: "src/cli.ts"
      provides: "Full CLI program with all commands registered"
  key_links:
    - from: "src/commands/init.ts"
      to: "src/notion/client.ts"
      via: "validateToken() before saving profile"
      pattern: "validateToken"
    - from: "src/commands/init.ts"
      to: "src/config/config.ts"
      via: "writeGlobalConfig() to persist profile"
      pattern: "writeGlobalConfig"
    - from: "src/cli.ts"
      to: "src/commands/*.ts"
      via: "command registration with Commander"
      pattern: "program\\.command|addCommand"
    - from: "src/notion/client.ts"
      to: "@notionhq/client"
      via: "creates Client instance with token"
      pattern: "new Client"
---

<objective>
Wire up the full CLI: `notion init` with interactive prompts and token validation, profile management commands, shell completions, and categorized help output.

Purpose: This is the user-facing culmination of Phase 1 — the user can authenticate, manage profiles, and get help. All infrastructure from Plans 01-03 connects here.
Output: Working CLI with `notion init`, `notion profile list/use/remove`, `notion completion`, and `notion --help`.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-auth/01-RESEARCH.md
@.planning/phases/01-foundation-auth/01-02-SUMMARY.md
@.planning/phases/01-foundation-auth/01-03-SUMMARY.md

<interfaces>
<!-- Contracts from Plans 01-03 -->

From src/types/config.ts:
```typescript
export interface ProfileConfig { token: string; workspace_name?: string; workspace_id?: string; }
export interface GlobalConfig { active_profile?: string; profiles?: Record<string, ProfileConfig>; }
export interface LocalConfig { profile?: string; token?: string; }
export interface TokenResult { token: string; source: 'NOTION_API_TOKEN' | '.notion.yaml' | `profile: ${string}`; }
```

From src/config/config.ts:
```typescript
export function readGlobalConfig(): Promise<GlobalConfig>;
export function writeGlobalConfig(config: GlobalConfig): Promise<void>;
```

From src/config/token.ts:
```typescript
export function resolveToken(): Promise<TokenResult>;
```

From src/errors/cli-error.ts:
```typescript
export class CliError extends Error {
  constructor(code: ErrorCode, message: string, suggestion?: string);
  format(): string;
}
```

From src/errors/error-handler.ts:
```typescript
export function withErrorHandling(fn: () => Promise<void>): () => Promise<void>;
```

From src/notion/url-parser.ts:
```typescript
export function parseNotionId(input: string): string;
export function toUuid(id: string): string;
```

From src/output/stderr.ts:
```typescript
export function stderrWrite(msg: string): void;
export function reportTokenSource(source: TokenResult['source']): void;
```

From src/output/color.ts:
```typescript
export function error(msg: string): string;
export function success(msg: string): string;
export function dim(msg: string): string;
export function bold(msg: string): string;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Notion client factory and init/profile commands</name>
  <files>
    src/notion/client.ts
    src/commands/init.ts
    src/commands/profile/list.ts
    src/commands/profile/use.ts
    src/commands/profile/remove.ts
  </files>
  <action>
1. Create `src/notion/client.ts`:
   - `validateToken(token: string): Promise<{ workspaceName: string; workspaceId: string }>` — per research code example:
     - Creates `new Client({ auth: token })` from `@notionhq/client`
     - Calls `notion.users.me()`
     - On success: extracts `workspace_name` and `workspace_id` from bot response
     - On `APIErrorCode.Unauthorized`: throws `CliError(AUTH_INVALID, 'Invalid integration token.', 'Check your token at notion.so/my-integrations')`
   - `createNotionClient(token: string): Client` — factory for authenticated client (used by future commands)

2. Create `src/commands/init.ts` — `notion init` command:
   - Export a function that creates and returns a Commander Command
   - Non-TTY check: if `!process.stdin.isTTY`, throw `CliError(AUTH_NO_TOKEN, 'Cannot run interactive init in non-TTY mode.', 'Set NOTION_API_TOKEN environment variable or create .notion.yaml')`
   - Interactive prompts using `@inquirer/prompts`:
     a. `input({ message: 'Profile name:', default: 'default' })` for profile name
     b. `password({ message: 'Integration token (from notion.so/my-integrations):', mask: '*' })` for token
   - Validate token with `validateToken(token)` — show workspace name on success
   - Check for existing profile — if exists, `confirm({ message: 'Profile "X" already exists. Replace?' })`
   - Save to global config via `writeGlobalConfig()` — set as active profile
   - Output success to stderr: `Profile "name" saved and set as active.`

3. Create `src/commands/profile/list.ts`:
   - Reads global config, lists all profiles
   - Marks active profile with `*` or `(active)`
   - Shows workspace name if cached
   - If no profiles, print "No profiles configured. Run `notion init` to get started."

4. Create `src/commands/profile/use.ts`:
   - Takes `<name>` argument
   - Reads global config, verifies profile exists (throw AUTH_PROFILE_NOT_FOUND if not)
   - Sets `active_profile` to the given name, writes config
   - Prints confirmation to stderr

5. Create `src/commands/profile/remove.ts`:
   - Takes `<name>` argument
   - Reads global config, verifies profile exists
   - If it's the active profile, unset `active_profile`
   - Removes profile from `profiles` map, writes config
   - Prints confirmation to stderr
  </action>
  <verify>
    <automated>npm run build && node dist/cli.js --help && node dist/cli.js profile list 2>&1</automated>
  </verify>
  <done>
- `notion init` prompts for profile name and token, validates, saves
- `notion init` shows workspace name on success
- `notion init` detects non-TTY and errors with guidance
- `notion profile list` shows profiles with active marker
- `notion profile use <name>` switches active profile
- `notion profile remove <name>` deletes profile and unsets active if needed
  </done>
</task>

<task type="auto">
  <name>Task 2: CLI wiring, completion command, and build verification</name>
  <files>
    src/cli.ts
    src/commands/completion.ts
  </files>
  <action>
1. Create `src/commands/completion.ts`:
   - Takes `<shell>` argument (bash, zsh, fish)
   - Outputs a static completion script to stdout for the given shell
   - For bash: generate basic completion script using `complete -W "command list" notion` pattern
   - For zsh: generate `_notion` completion function with `_arguments` or `compadd`
   - For fish: generate `complete -c notion -n ...` commands
   - Include completions for: init, profile (list, use, remove), completion, --help, --version, --verbose, --color
   - This is a starting point — completions will grow as commands are added in later phases

2. Update `src/cli.ts` to wire ALL commands:
   - Import and register `initCommand` under `program.command('init')`
   - Create `profile` subcommand group: `program.command('profile').summary('manage authentication profiles')`
   - Register `profileListCommand`, `profileUseCommand`, `profileRemoveCommand` under profile group
   - Register `completionCommand` under `program.command('completion')`
   - Wrap ALL command actions with `withErrorHandling()`
   - Set up Commander Help Groups for categorized `--help` output (if Commander v14 supports it, otherwise group visually via command ordering and descriptions)
   - Ensure `--verbose` and `--color` are accessible to all commands via `program.opts()`

3. Build and verify:
   - `npm run build`
   - Test that `notion --help` shows all commands categorized
   - Test that `notion --version` still works
   - Test that `notion profile list` works (should show "No profiles configured")
   - Test that `notion completion bash` outputs a completion script
  </action>
  <verify>
    <automated>npm run build && node dist/cli.js --help && node dist/cli.js profile list 2>&1 && node dist/cli.js completion bash | head -5</automated>
  </verify>
  <done>
- `notion --help` shows all commands with descriptions, grouped logically
- `notion init` is registered and callable
- `notion profile list/use/remove` are registered as subcommands
- `notion completion bash/zsh/fish` outputs completion scripts
- All commands wrapped with error handling
- Build produces working dist/cli.js
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete CLI interactive flow</name>
  <files>dist/cli.js</files>
  <action>
Human verification checkpoint. Claude built the complete CLI with auth flow, profile management, help output, and shell completions. User verifies the interactive experience works correctly.
  </action>
  <verify>
User runs the following manual checks:
1. `node dist/cli.js --help` — commands listed with descriptions
2. `node dist/cli.js --version` — version prints
3. `node dist/cli.js init` — interactive flow: profile name → token → validation → saved
4. `node dist/cli.js profile list` — profile appears with (active)
5. `node dist/cli.js profile use <name>` — confirms switch
6. `node dist/cli.js completion bash` — outputs completion script
7. `echo "test" | node dist/cli.js init` — non-TTY detection error
  </verify>
  <done>User types "approved" confirming the CLI interactive flow works as expected</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `notion --help` shows categorized commands
- `notion --version` shows version
- `notion init` interactive flow works end-to-end
- `notion profile list/use/remove` work correctly
- `notion completion bash` outputs script
- Non-TTY detection works
- All tests pass: `npm test`
</verification>

<success_criteria>
1. User can complete full init flow: enter profile name, token, see validation, profile saved
2. Profile management commands all work (list, use, remove)
3. Help output is clear and categorized
4. Shell completions generated for bash/zsh/fish
5. Error handling works end-to-end (invalid token → structured error on stderr)
6. Human verification confirms the interactive flow feels right
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-auth/01-04-SUMMARY.md`
</output>
