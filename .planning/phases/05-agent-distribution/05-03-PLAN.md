---
phase: 05-agent-distribution
plan: "03"
type: execute
wave: 2
depends_on:
  - "05-01"
  - "05-02"
files_modified: []
autonomous: false
requirements:
  - DIST-01

must_haves:
  truths:
    - "npm pack produces a clean tarball with correct files"
    - "Installing from the local tarball works: the notion binary is available in PATH after install"
    - "notion --version and notion --help work after global install from tarball"
    - "notion init prompts correctly in the installed version"
    - "User publishes to npm and the package is available at npm install -g @andrzejchm/notion-cli"
  artifacts:
    - path: "*.tgz"
      provides: "Publishable npm tarball created by npm pack"
      contains: "dist/cli.js"
  key_links:
    - from: "npm install -g @andrzejchm/notion-cli"
      to: "dist/cli.js"
      via: "npm global bin symlink → ./dist/cli.js (shebang: #!/usr/bin/env node)"
      pattern: "notion"
---

<objective>
Verify the package installs and runs correctly from the local tarball, then publish to npm.

Purpose: The only way to know `npm install -g @andrzejchm/notion-cli` actually works is to simulate it locally before publishing. Once verified, the user publishes.
Output: Live npm package at https://www.npmjs.com/package/@andrzejchm/notion-cli
</objective>

<execution_context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</execution_context>

<context>
@.planning/phases/05-agent-distribution/05-01-SUMMARY.md
@.planning/phases/05-agent-distribution/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build, pack, and verify local install</name>
  <files>— (no source files modified)</files>
  <action>
Run the following verification sequence. Fix any issues found before moving to the checkpoint.

**Step 1: Clean build**
```bash
npm run build
```
Must produce `dist/cli.js` with the `#!/usr/bin/env node` shebang as the first line.

**Step 2: Pack into tarball**
```bash
npm pack
```
This creates `andrzejchm-notion-cli-0.1.0.tgz` (or similar name).

**Step 3: Verify tarball contents**
```bash
tar -tzf andrzejchm-notion-cli-*.tgz | sort
```
Must include:
- `package/package.json`
- `package/README.md`
- `package/dist/cli.js`
- `package/docs/agent-skill.md`

Must NOT include: `package/src/`, `package/tests/`, `package/.planning/`, `package/tsconfig.json`

**Step 4: Install globally from local tarball**
```bash
npm install -g ./andrzejchm-notion-cli-*.tgz
```

**Step 5: Verify binary works**
```bash
which notion          # must find the binary in PATH
notion --version      # must show 0.1.0
notion --help         # must show all commands (init, search, ls, open, read, db, users, comments, profile, completion)
```

**Step 6: Uninstall local test install (cleanup)**
```bash
npm uninstall -g @andrzejchm/notion-cli
```

**If any step fails:** Fix the issue (e.g., wrong files array, missing shebang, dist not included) and repeat from Step 1. Document what was fixed.
  </action>
  <verify>npm run build && npm pack && tar -tzf andrzejchm-notion-cli-*.tgz | grep "dist/cli.js" && echo "tarball OK"</verify>
  <done>Tarball contains dist/cli.js. Local install succeeded. notion --version and notion --help both work after install from tarball.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verify install + approve npm publish</name>
  <files>— (human action required)</files>
  <action>Human verifies the local install and approves publishing to npm registry.</action>
  <verify>User confirms the binary works and approves publishing</verify>
  <done>User types "approved" or "publish" to confirm the CLI works and they want to publish</done>
  <what-built>
    The CLI is packaged and ready for global npm distribution:
    - Clean build in dist/
    - Tarball includes only runtime files (dist/, docs/agent-skill.md, README.md)
    - Local install from tarball was verified (notion --version, notion --help)
    - Agent skill file is included in the package
    - README.md is the npm package page
  </what-built>
  <how-to-verify>
    **Manual verification (do this yourself):**
    
    1. Install from the local tarball:
       ```bash
       npm install -g ./andrzejchm-notion-cli-*.tgz
       ```
    
    2. Test the installed binary:
       ```bash
       notion --version     # should show 0.1.0
       notion --help        # should list all commands
       notion search "test" # should work with your token
       ```
    
    3. Uninstall the test install:
       ```bash
       npm uninstall -g @andrzejchm/notion-cli
       ```
    
    **When ready to publish**, run:
    ```bash
    npm login   # if not already logged in to npm
    npm publish --access public
    ```
    
    Then verify the publish succeeded:
    ```bash
    npm info @andrzejchm/notion-cli
    npm install -g @andrzejchm/notion-cli   # install from registry
    notion --version
    ```
  </how-to-verify>
  <resume-signal>Type "approved" once you've verified the install works and published to npm. Include the npm package URL if published.</resume-signal>
</task>

</tasks>

<verification>
- npm run build succeeds
- npm pack creates tarball with dist/cli.js and docs/agent-skill.md
- notion --version works after installing from local tarball
- npm publish completes successfully (user action)
- npm info @andrzejchm/notion-cli shows the published package
</verification>

<success_criteria>
- DIST-01: `npm install -g @andrzejchm/notion-cli` installs a working notion binary
- The published package page on npmjs.com shows README.md correctly
- notion --help shows all commands after global install
- User has published and confirmed success
</success_criteria>

<output>
After completion, create `.planning/phases/05-agent-distribution/05-03-SUMMARY.md`
</output>
