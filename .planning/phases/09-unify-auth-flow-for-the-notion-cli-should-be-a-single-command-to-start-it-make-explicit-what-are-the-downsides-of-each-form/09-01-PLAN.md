---
phase: 09-unify-auth-flow-for-the-notion-cli-should-be-a-single-command-to-start-it-make-explicit-what-are-the-downsides-of-each-form
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/init.ts
  - src/commands/auth/index.ts
  - src/cli.ts
autonomous: false
requirements:
  - AUTH-UX-01
  - AUTH-UX-02
  - AUTH-UX-03

must_haves:
  truths:
    - "Running `notion auth` with no subcommand shows an interactive selector with two choices and inline tradeoff descriptions"
    - "Selecting 'OAuth user login' in the selector completes the browser OAuth flow and stores tokens (same as `notion auth login`)"
    - "Selecting 'Internal integration token' in the selector prompts for and validates the integration token (same as `notion init`)"
    - "`notion init` still works unchanged for backward compatibility"
    - "`notion auth login`, `notion auth logout`, `notion auth status` still work correctly after adding action to authCmd"
    - "Running `notion auth` in a non-TTY pipe throws a CliError with message directing user to `notion auth login` or `notion init`"
  artifacts:
    - path: "src/commands/auth/index.ts"
      provides: "authDefaultAction() — interactive selector that delegates to OAuth or init flow"
      exports: ["authDefaultAction"]
    - path: "src/commands/init.ts"
      provides: "runInitFlow() exported function extracted from command action body"
      exports: ["initCommand", "runInitFlow"]
    - path: "src/cli.ts"
      provides: "authCmd wired with authDefaultAction via .action()"
      contains: "authCmd.action(authDefaultAction())"
  key_links:
    - from: "src/cli.ts"
      to: "src/commands/auth/index.ts"
      via: "import { authDefaultAction }"
      pattern: "authDefaultAction"
    - from: "src/commands/auth/index.ts"
      to: "src/commands/init.ts"
      via: "import { runInitFlow }"
      pattern: "runInitFlow"
    - from: "src/commands/auth/index.ts"
      to: "src/oauth/oauth-flow.ts"
      via: "import { runOAuthFlow }"
      pattern: "runOAuthFlow"
---

<objective>
Create `notion auth` as a unified interactive authentication entry point that lets users choose between OAuth and internal integration token, with inline tradeoff descriptions for each choice.

Purpose: First-time users encounter a single, discoverable command that guides them to the right auth method while being transparent about tradeoffs — instead of needing to independently discover `notion init` vs `notion auth login`.

Output: `src/commands/auth/index.ts` (new), updated `src/commands/init.ts` (extracted `runInitFlow`), updated `src/cli.ts` (wired action).
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/09-unify-auth-flow-for-the-notion-cli-should-be-a-single-command-to-start-it-make-explicit-what-are-the-downsides-of-each-form/09-RESEARCH.md

<interfaces>
<!-- Key contracts the executor needs. Extracted from codebase. -->

From src/commands/init.ts (current action body to extract):
```typescript
// The action body currently inside cmd.action(withErrorHandling(async () => { ... }))
// must be extracted into an exported async function:
export async function runInitFlow(): Promise<void>
// Body: TTY check, input/password/confirm prompts, validateToken, readGlobalConfig, writeGlobalConfig, access probe
// The TTY check in runInitFlow should be REMOVED — caller (authDefaultAction) already guards TTY
// initCommand() wraps runInitFlow in withErrorHandling with its own TTY check
```

From src/commands/auth/login.ts (OAuth flow pattern):
```typescript
// OAuth login flow calls (in order):
const config = await readGlobalConfig();
const profileName = opts.profile ?? config.active_profile ?? 'default';
const result = await runOAuthFlow({ manual: opts.manual });   // opens browser
const response = await exchangeCode(result.code);              // exchanges auth code
await saveOAuthTokens(profileName, response);                  // persists tokens
const userName = response.owner?.user?.name ?? 'unknown user';
```

From src/cli.ts (authCmd wiring, lines 72-77):
```typescript
const authCmd = new Command('auth').description('manage Notion authentication');
authCmd.addCommand(loginCommand());
authCmd.addCommand(logoutCommand());
authCmd.addCommand(statusCommand());
program.addCommand(authCmd);
// TARGET: add authCmd.action(authDefaultAction()) before addCommand calls
```

From src/errors/cli-error.ts + src/errors/codes.ts:
```typescript
throw new CliError(
  ErrorCodes.AUTH_NO_TOKEN,
  'Cannot run interactive auth in non-TTY mode.',
  'Use "notion auth login" for OAuth or "notion init" for integration token',
);
```

From src/output/color.ts (available helpers):
```typescript
export function success(msg: string): string;
export function dim(msg: string): string;
export function bold(msg: string): string;
```

@inquirer/prompts select usage:
```typescript
import { select } from '@inquirer/prompts';
const method = await select({
  message: 'How do you want to authenticate with Notion?',
  choices: [
    {
      name: 'OAuth user login  (browser required)',
      value: 'oauth' as const,
      description: 'Opens Notion in your browser. Comments and pages are attributed to your account. Tokens auto-refresh.',
    },
    {
      name: 'Internal integration token  (CI/headless friendly)',
      value: 'token' as const,
      description: 'Paste a token from notion.so/profile/integrations. No browser needed. Write ops attributed to integration bot.',
    },
  ],
});
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract runInitFlow from init.ts and create authDefaultAction in src/commands/auth/index.ts</name>
  <files>src/commands/init.ts, src/commands/auth/index.ts</files>
  <action>
**Step A — Extract `runInitFlow()` from `src/commands/init.ts`:**

1. In `src/commands/init.ts`, extract the body of `cmd.action(withErrorHandling(async () => { ... }))` into a new exported async function `runInitFlow()`.
2. The TTY check (`if (!process.stdin.isTTY)`) stays INSIDE `initCommand()`'s action (keep backward-compat guard), but `runInitFlow()` itself should NOT have the TTY check — it is a pure flow function that the caller guards.
3. `runInitFlow()` accepts no arguments and returns `Promise<void>`.
4. The `initCommand()` action body becomes: TTY check + `await runInitFlow()`.
5. Export `runInitFlow` from the file alongside `initCommand`.

**Step B — Create `src/commands/auth/index.ts`:**

Create this new file with an `authDefaultAction()` function:

```typescript
import { select } from '@inquirer/prompts';
import { CliError } from '../../errors/cli-error.js';
import { ErrorCodes } from '../../errors/codes.js';
import { withErrorHandling } from '../../errors/error-handler.js';
import { readGlobalConfig } from '../../config/config.js';
import { runOAuthFlow } from '../../oauth/oauth-flow.js';
import { exchangeCode } from '../../oauth/oauth-client.js';
import { saveOAuthTokens } from '../../oauth/token-store.js';
import { stderrWrite } from '../../output/stderr.js';
import { success, dim } from '../../output/color.js';
import { runInitFlow } from '../init.js';

export function authDefaultAction(): () => Promise<void> {
  return withErrorHandling(async () => {
    if (!process.stdin.isTTY) {
      throw new CliError(
        ErrorCodes.AUTH_NO_TOKEN,
        'Cannot run interactive auth in non-TTY mode.',
        'Use "notion auth login" for OAuth or "notion init" for integration token',
      );
    }

    const method = await select({
      message: 'How do you want to authenticate with Notion?',
      choices: [
        {
          name: 'OAuth user login  (browser required)',
          value: 'oauth' as const,
          description:
            'Opens Notion in your browser. Comments and pages are attributed to your account. Tokens auto-refresh.',
        },
        {
          name: 'Internal integration token  (CI/headless friendly)',
          value: 'token' as const,
          description:
            'Paste a token from notion.so/profile/integrations. No browser needed. Write ops attributed to integration bot.',
        },
      ],
    });

    if (method === 'oauth') {
      const config = await readGlobalConfig();
      const profileName = config.active_profile ?? 'default';
      const result = await runOAuthFlow();
      const response = await exchangeCode(result.code);
      await saveOAuthTokens(profileName, response);
      const userName = response.owner?.user?.name ?? 'unknown user';
      const workspaceName = response.workspace_name ?? 'unknown workspace';
      stderrWrite(success(`✓ Logged in as ${userName} to workspace ${workspaceName}`));
      stderrWrite(dim('Your comments and pages will now be attributed to your Notion account.'));
    } else {
      await runInitFlow();
    }
  });
}
```

Note: `withErrorHandling` signature wraps an async `() => Promise<void>` and returns `() => Promise<void>`. Match the existing pattern from `login.ts` (the action is `withErrorHandling(async (opts) => {...})` — for no-opts commands it is `withErrorHandling(async () => {...})`).
  </action>
  <verify>
    <automated>cd /Users/andrzejchm/Developer/notion-cli && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>TypeScript compiles with no errors. `src/commands/auth/index.ts` exists and exports `authDefaultAction`. `src/commands/init.ts` exports both `initCommand` and `runInitFlow`.</done>
</task>

<task type="auto">
  <name>Task 2: Wire authDefaultAction into cli.ts and build</name>
  <files>src/cli.ts</files>
  <action>
In `src/cli.ts`:

1. Add import at top of auth imports section:
   ```typescript
   import { authDefaultAction } from './commands/auth/index.js';
   ```

2. In the auth subcommand group (lines 72-77), add `.action(authDefaultAction())` to `authCmd` **before** the `addCommand` calls:
   ```typescript
   const authCmd = new Command('auth').description('manage Notion authentication');
   authCmd.action(authDefaultAction());   // fires when no subcommand given
   authCmd.addCommand(loginCommand());
   authCmd.addCommand(logoutCommand());
   authCmd.addCommand(statusCommand());
   program.addCommand(authCmd);
   ```

   The `.action()` call must come before `addCommand` calls — this is the Commander v14 pattern.

3. Run build to confirm no runtime errors:
   ```bash
   npm run build
   ```
  </action>
  <verify>
    <automated>cd /Users/andrzejchm/Developer/notion-cli && npm run build 2>&1 | tail -10 && node dist/cli.js auth --help 2>&1 | head -20</automated>
  </verify>
  <done>Build succeeds. `node dist/cli.js auth --help` shows the auth subcommands (login, logout, status) listed under it. `node dist/cli.js auth login --help` still shows the OAuth login options.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verify — `notion auth` selector and subcommand backward compat</name>
  <what-built>
    - `notion auth` (no subcommand) now shows an interactive selector with two choices:
      1. "OAuth user login  (browser required)" — with description about user attribution and auto-refresh
      2. "Internal integration token  (CI/headless friendly)" — with description about CI-friendliness and bot attribution
    - Selecting OAuth completes the browser OAuth flow
    - Selecting integration token runs the same prompts as `notion init`
    - `notion init` still works unchanged
    - `notion auth login`, `notion auth logout`, `notion auth status` still work
  </what-built>
  <how-to-verify>
    1. Run `node dist/cli.js auth` — confirm selector appears with two choices and their description text visible below
    2. Use arrow keys to navigate — confirm description updates for each choice
    3. Press Ctrl+C to cancel
    4. Run `node dist/cli.js auth login --help` — confirm it still shows OAuth options (not the selector)
    5. Run `node dist/cli.js auth status` — confirm it still works
    6. Run `node dist/cli.js init` — confirm it still works and prompts for token
    7. In a non-TTY: `echo "" | node dist/cli.js auth 2>&1` — confirm error message says "Use notion auth login for OAuth or notion init for integration token"
  </how-to-verify>
  <action>Human verification step — no automated action. Review the built artifacts listed in what-built and follow the how-to-verify steps.</action>
  <verify>
    <automated>cd /Users/andrzejchm/Developer/notion-cli && node dist/cli.js auth --help 2>&1 | head -10</automated>
  </verify>
  <done>User confirms "approved" after verifying the selector UI, subcommand routing, and non-TTY error message.</done>
  <resume-signal>Type "approved" or describe what's wrong</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no type errors
- `npm run build` succeeds
- `node dist/cli.js auth` shows interactive selector (visual verify)
- `node dist/cli.js auth login --help` still shows OAuth subcommand help
- `node dist/cli.js auth status` still works
- `node dist/cli.js init` still works
- Non-TTY `echo "" | node dist/cli.js auth 2>&1` outputs CliError message
</verification>

<success_criteria>
- `src/commands/auth/index.ts` exists with `authDefaultAction()` exported
- `src/commands/init.ts` exports `runInitFlow()` alongside `initCommand()`
- `src/cli.ts` imports and wires `authDefaultAction()` onto `authCmd`
- Interactive selector works in TTY with tradeoffs visible in description
- All existing `auth` subcommands and `init` still work unchanged
- Non-TTY produces a helpful CliError
</success_criteria>

<output>
After completion, create `.planning/phases/09-unify-auth-flow-for-the-notion-cli-should-be-a-single-command-to-start-it-make-explicit-what-are-the-downsides-of-each-form/09-01-SUMMARY.md`
</output>
