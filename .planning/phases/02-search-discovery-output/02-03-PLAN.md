---
phase: 02-search-discovery-output
plan: "03"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - src/commands/open.ts
  - src/commands/users.ts
  - src/commands/comments.ts
autonomous: true
requirements:
  - SRCH-04
  - META-01
  - META-02

must_haves:
  truths:
    - "User can open a Notion page in their browser with notion open <id/url>"
    - "User can list workspace users with notion users"
    - "User can read comments on a page with notion comments <id/url>"
  artifacts:
    - path: "src/commands/open.ts"
      provides: "notion open <id/url> — opens page in browser without API call"
      exports: ["openCommand"]
    - path: "src/commands/users.ts"
      provides: "notion users — lists all workspace users"
      exports: ["usersCommand"]
    - path: "src/commands/comments.ts"
      provides: "notion comments <id/url> — lists comments on a page"
      exports: ["commentsCommand"]
  key_links:
    - from: "src/commands/open.ts"
      to: "src/notion/url-parser.ts"
      via: "parseNotionId(idOrUrl) — extract ID, reconstruct Notion URL"
      pattern: "parseNotionId"
    - from: "src/commands/users.ts"
      to: "src/output/paginate.ts"
      via: "paginateResults((cursor) => notion.users.list({start_cursor: cursor}))"
      pattern: "paginateResults"
    - from: "src/commands/comments.ts"
      to: "src/output/paginate.ts"
      via: "paginateResults((cursor) => notion.comments.list({block_id, start_cursor: cursor}))"
      pattern: "paginateResults"
---

<objective>
Implement `notion open`, `notion users`, and `notion comments` — three lightweight meta/utility commands.

Purpose: Completes the discovery surface: open pages in browser, list team members, read discussion threads.
Output: Three command files, not yet wired into CLI (that's 02-04).
</objective>

<execution_context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</execution_context>

<context>
@.planning/phases/02-search-discovery-output/02-01-SUMMARY.md

<interfaces>
<!-- From 02-01: output utilities -->
From src/output/format.ts:
```typescript
export type OutputMode = 'auto' | 'json' | 'md';
export function setOutputMode(mode: OutputMode): void
export function printOutput(data: unknown, tableHeaders?: string[], tableRows?: string[][]): void
```

From src/output/paginate.ts:
```typescript
export async function paginateResults<T>(
  fetcher: (cursor?: string) => Promise<{ results: T[]; next_cursor: string | null; has_more: boolean }>
): Promise<T[]>
```

<!-- From Phase 1 -->
From src/notion/url-parser.ts:
```typescript
export function parseNotionId(input: string): string
// Returns lowercase 32-char hex ID (no dashes). Throws CliError(INVALID_ID) on bad input.

export function toUuid(id: string): string
// Converts 32-char hex to UUID format: 8-4-4-4-12 with dashes
```

From src/config/token.ts:
```typescript
export async function resolveToken(): Promise<TokenResult>
```

From src/notion/client.ts:
```typescript
export function createNotionClient(token: string): Client
```

From src/output/stderr.ts:
```typescript
export function reportTokenSource(source: TokenResult['source']): void
```

From src/errors/error-handler.ts:
```typescript
export function withErrorHandling<T extends (...args: any[]) => Promise<void>>(fn: T): T
```

<!-- Notion SDK types for users and comments -->
UserObjectResponse (from @notionhq/client):
```typescript
{
  object: 'user',
  id: string,
  type: 'person' | 'bot',
  name: string | null,
  avatar_url: string | null,
  person?: { email: string },
  bot?: { workspace_name: string | null }
}
```

CommentObjectResponse (from @notionhq/client):
```typescript
{
  object: 'comment',
  id: string,
  parent: { type: 'page_id' | 'block_id'; page_id?: string; block_id?: string },
  discussion_id: string,
  created_time: string,
  last_edited_time: string,
  created_by: { object: 'user'; id: string },
  rich_text: Array<{ plain_text: string; ... }>
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: notion open and notion users commands</name>
  <files>src/commands/open.ts, src/commands/users.ts</files>
  <action>
**src/commands/open.ts — `notion open <id/url>`**

Opens a Notion page in the default browser. No API call required — construct URL from ID directly.

```typescript
export function openCommand(): Command
```

Implementation:
1. Parse the argument with `parseNotionId(idOrUrl)` — throws CliError if invalid
2. Reconstruct Notion URL: `https://www.notion.so/${id}` (Notion redirects 32-char hex IDs correctly without dashes)
3. Detect OS and open browser:
   ```typescript
   import { exec } from 'node:child_process';
   import { promisify } from 'node:util';
   const execAsync = promisify(exec);

   const platform = process.platform;
   const opener = platform === 'darwin' ? 'open'
     : platform === 'win32' ? 'start'
     : 'xdg-open';  // Linux

   await execAsync(`${opener} "${url}"`);
   ```
4. Print to stdout: `Opening ${url}` (so piped usage is scriptable)
5. Wrap in `withErrorHandling`
6. No `--json` flag needed (open is not a data command)

---

**src/commands/users.ts — `notion users`**

Lists all users in the workspace.

```typescript
export function usersCommand(): Command
```

Implementation:
1. `resolveToken()` → `createNotionClient(token)`, call `reportTokenSource(source)`
2. `paginateResults((cursor) => notion.users.list({ start_cursor: cursor }))`
3. Filter to full user objects: use `isFullUser` from `@notionhq/client` if available, or check `item.type !== undefined`
4. Build table rows: `[user.type, user.name ?? '(unnamed)', user.person?.email ?? user.bot?.workspace_name ?? '—', user.id]`
5. `printOutput(users, ['TYPE', 'NAME', 'EMAIL / WORKSPACE', 'ID'], rows)`
6. `--json` flag: call `setOutputMode('json')` before fetching
7. Wrap in `withErrorHandling`

Note: `isFullUser` may not exist in @notionhq/client v5 — use type assertion: `(users as UserObjectResponse[]).filter(u => u.name !== undefined)`
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep -E "open\.ts|users\.ts" || echo "no errors"</verify>
  <done>open.ts exports openCommand() with cross-platform browser open (no API call). users.ts exports usersCommand() with pagination and printOutput. Both compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: notion comments command</name>
  <files>src/commands/comments.ts</files>
  <action>
Create `src/commands/comments.ts` implementing `notion comments <id/url>` — lists all comments on a Notion page.

**Command signature:**
```
notion comments <id/url> [--json]
```

```typescript
export function commentsCommand(): Command
```

**Implementation:**
1. Parse `<id/url>` with `parseNotionId(idOrUrl)` → get 32-char hex ID
2. Convert to UUID format: `const uuid = toUuid(id)` (Notion API requires UUID-formatted block_id for comments)
3. `resolveToken()` → `createNotionClient(token)`, call `reportTokenSource(source)`
4. `paginateResults((cursor) => notion.comments.list({ block_id: uuid, start_cursor: cursor }))`
5. Extract comment text: `comment.rich_text.map(t => t.plain_text).join('')`
6. Build table rows:
   ```typescript
   [
     comment.created_time.split('T')[0],           // DATE
     comment.created_by.id.slice(0, 8) + '...',    // AUTHOR (partial ID, full name unavailable in comment obj)
     text.slice(0, 80) + (text.length > 80 ? '…' : '')  // COMMENT (truncated to 80 chars in table)
   ]
   ```
7. Table headers: `['DATE', 'AUTHOR ID', 'COMMENT']`
8. JSON output: full comment objects (not truncated)
9. `printOutput(comments, headers, rows)`
10. `--json` flag: `setOutputMode('json')` before fetching
11. Wrap in `withErrorHandling`

**Empty results:** Print `No comments found on this page` and exit 0.

**Note on author display:** The comments API returns `created_by.id` but not the user's name (fetching names would require N+1 API calls). Display partial ID in table mode. JSON mode has the full comment object including created_by.id so callers can resolve names from `notion users` output.
  </action>
  <verify>npx tsc --noEmit 2>&1 | grep "comments.ts" || echo "no errors"</verify>
  <done>src/commands/comments.ts exports commentsCommand(), uses toUuid() for block_id, paginates results, displays date+author+text in table mode, full JSON in --json mode</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors in open.ts, users.ts, comments.ts
- open.ts uses child_process exec with cross-platform opener (open/xdg-open/start)
- users.ts lists users with TYPE, NAME, EMAIL/WORKSPACE, ID columns
- comments.ts converts ID to UUID format before passing to comments.list()
- All three commands wrap their action in withErrorHandling
</verification>

<success_criteria>
- src/commands/open.ts, users.ts, comments.ts exist and export their command factories
- notion open constructs URL as https://www.notion.so/{32-hex-id} without API call
- notion users paginates notion.users.list()
- notion comments paginates notion.comments.list() with block_id in UUID format
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-search-discovery-output/02-03-SUMMARY.md`
</output>
