---
phase: 02-search-discovery-output
plan: "04"
type: execute
wave: 3
depends_on:
  - "02-02"
  - "02-03"
files_modified:
  - src/cli.ts
autonomous: false
requirements:
  - SRCH-01
  - SRCH-02
  - SRCH-03
  - SRCH-04
  - SRCH-05
  - META-01
  - META-02
  - OUT-01
  - OUT-02
  - OUT-03
  - OUT-04

must_haves:
  truths:
    - "notion search <query> is available and returns results"
    - "notion ls lists accessible content in formatted table or JSON"
    - "notion open <id/url> opens a page in the browser"
    - "notion users lists workspace members"
    - "notion comments <id/url> shows page comments"
    - "notion --json and notion --md flags override TTY detection globally"
    - "notion --help shows all Phase 2 commands in the Discovery section"
  artifacts:
    - path: "src/cli.ts"
      provides: "All Phase 2 commands wired into CLI with global --json/--md flags"
      contains: "searchCommand|lsCommand|openCommand|usersCommand|commentsCommand"
  key_links:
    - from: "src/cli.ts preAction hook"
      to: "src/output/format.ts setOutputMode"
      via: "setOutputMode('json') when --json flag is set, setOutputMode('md') when --md flag is set"
      pattern: "setOutputMode"
    - from: "src/cli.ts"
      to: "src/commands/search.ts"
      via: "program.addCommand(searchCommand())"
      pattern: "searchCommand"
---

<objective>
Wire all Phase 2 commands into the CLI and add global --json/--md output flags. Then human-verify the complete Phase 2 feature set works end-to-end.

Purpose: Commands implemented in 02-02/02-03 are not yet accessible — this plan connects them to the CLI entry point and validates the full user experience.
Output: Updated src/cli.ts with all 5 new commands registered and output mode flags.
</objective>

<execution_context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</execution_context>

<context>
@.planning/phases/02-search-discovery-output/02-02-SUMMARY.md
@.planning/phases/02-search-discovery-output/02-03-SUMMARY.md

<interfaces>
<!-- Current cli.ts structure — update this file -->
From src/cli.ts (current state, Phase 1):
```typescript
// Global options currently: --verbose, --color
// preAction hook: sets color forced
// Commands registered: initCommand, profileCmd group, completionCommand

// Pattern to follow for new commands:
program.addCommand(someCommand());

// Pattern for grouped commands (if needed):
const groupCmd = new Command('group').description('...');
groupCmd.addCommand(subCommand());
program.addCommand(groupCmd);
```

From src/output/format.ts (02-01):
```typescript
export function setOutputMode(mode: 'auto' | 'json' | 'md'): void
```

<!-- All command factories from 02-02 and 02-03 -->
```typescript
// src/commands/search.ts
export function searchCommand(): Command

// src/commands/ls.ts
export function lsCommand(): Command

// src/commands/open.ts
export function openCommand(): Command

// src/commands/users.ts
export function usersCommand(): Command

// src/commands/comments.ts
export function commentsCommand(): Command
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Phase 2 commands into CLI</name>
  <files>src/cli.ts</files>
  <action>
Update `src/cli.ts` to add global `--json`/`--md` flags and register all 5 Phase 2 commands.

**1. Add global output flags to program:**
```typescript
program
  .option('--verbose', 'show API requests/responses')
  .option('--color', 'force color output')
  .option('--json', 'force JSON output (overrides TTY detection)')
  .option('--md', 'force markdown output for page content');
```

**2. Update preAction hook to set output mode:**
```typescript
program.hook('preAction', (thisCommand) => {
  const opts = thisCommand.opts<{ color?: boolean; verbose?: boolean; json?: boolean; md?: boolean }>();
  if (opts.color) {
    setColorForced(true);
  }
  if (opts.json) {
    setOutputMode('json');
  } else if (opts.md) {
    setOutputMode('md');
  }
  // else: 'auto' (default) — TTY detection in format.ts handles it
});
```

**3. Add imports at top of cli.ts:**
```typescript
import { setOutputMode } from './output/format.js';
import { searchCommand } from './commands/search.js';
import { lsCommand } from './commands/ls.js';
import { openCommand } from './commands/open.js';
import { usersCommand } from './commands/users.js';
import { commentsCommand } from './commands/comments.js';
```

**4. Register all Phase 2 commands in the Discovery section:**
```typescript
// --- Discovery ---
program.addCommand(searchCommand());
program.addCommand(lsCommand());
program.addCommand(openCommand());
program.addCommand(usersCommand());
program.addCommand(commentsCommand());
```

Add a comment `// --- Discovery ---` above these to match the `// --- Authentication ---` section style from Phase 1.

**5. Run build to verify:**
```bash
npm run build
```

The build must succeed with no TypeScript errors before moving to the verification checkpoint.
  </action>
  <verify>npm run build 2>&1 | tail -5</verify>
  <done>Build succeeds. `notion --help` shows search, ls, open, users, comments commands. `notion search --help` shows --type and --json flags.</done>
</task>

<task type="checkpoint:human-verify">
  <name>Task 2: Verify Phase 2 commands end-to-end</name>
  <action>Human verifies all Phase 2 commands work correctly in TTY and piped modes</action>
  <verify>Human approval via resume-signal</verify>
  <done>All 5 commands function correctly, dual-mode output confirmed, human types "approved"</done>
  <what-built>
All Phase 2 commands wired into the CLI:
- `notion search <query>` — keyword search with optional --type and --json
- `notion ls` — list all accessible pages/databases (table or JSON)
- `notion open <id/url>` — opens page in default browser
- `notion users` — lists workspace members
- `notion comments <id/url>` — lists page comments
- Global `--json` and `--md` flags on the program
  </what-built>
  <how-to-verify>
Run each command against your real Notion workspace. Verify TTY output is a formatted table, piped output is JSON.

**Step 1: Build check**
```bash
npm run build
notion --help
```
Expected: help shows all new commands listed under the program (search, ls, open, users, comments)

**Step 2: notion ls (TTY table mode)**
```bash
notion ls
```
Expected: Formatted table with TYPE, TITLE, ID, MODIFIED columns. All accessible pages and databases listed.

**Step 3: notion ls (JSON piped mode)**
```bash
notion ls | head -20
```
Expected: JSON array of page/database objects (not table)

**Step 4: notion ls (forced JSON with flag)**
```bash
notion --json ls
```
Expected: JSON output even in TTY

**Step 5: notion search**
```bash
notion search "test"
```
Expected: Table showing results matching "test". If none, prints "No results found".

```bash
notion search "test" --type page
```
Expected: Only pages in results (no databases)

**Step 6: notion users**
```bash
notion users
```
Expected: Table with TYPE, NAME, EMAIL/WORKSPACE, ID columns

**Step 7: notion open**
Get a page ID from `notion ls` output, then:
```bash
notion open <some-page-id>
```
Expected: Prints "Opening https://www.notion.so/..." and browser opens the page

**Step 8: notion comments** (use any page that has comments, or skip if none)
```bash
notion comments <page-id>
```
Expected: Table with DATE, AUTHOR ID, COMMENT columns. Or "No comments found" if none.

**Step 9: Pagination** (confirm auto-pagination for large workspaces)
```bash
notion ls --json | python3 -c "import json,sys; data=json.load(sys.stdin); print(f'{len(data)} items')"
```
Expected: Count matches actual workspace content (if >100 items, confirms pagination is working)
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 2, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no TypeScript errors
- `notion --help` shows all 5 Phase 2 commands
- `notion ls` shows table in TTY, JSON when piped
- `notion --json ls` forces JSON even in TTY
- `notion search <query>` returns results with TYPE, TITLE, ID, MODIFIED columns
- `notion search <query> --type page` filters to pages only
- `notion open <id>` opens browser and prints the URL
- `notion users` lists workspace members
- Auto-pagination confirmed (ls returns all items, not just first page)
</verification>

<success_criteria>
- All 5 Phase 2 commands accessible via notion CLI
- Dual-mode output working: TTY = table, piped = JSON, --json flag overrides
- --type filter works on search and ls
- notion open works on macOS (and cross-platform by design)
- Build passes, TypeScript compiles cleanly
- Human approves during checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/02-search-discovery-output/02-04-SUMMARY.md`
</output>
